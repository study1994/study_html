<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>数据处理</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
.hidden-code {
  display: none !important;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/mycss/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/myjs/d3@6.7.0.js"></script>
    <script src="https://study1994.github.io/study_html/npm/myjs/markmap-view@0.13.5.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">nyc(projects/configs/vma_icurb.py)</p><span class=\'hidden-code\' data-code=\'map_classes = [\'curb\']\nfixed_ptsnum_per_gt_line = 50 now only support fixed_pts > 0\nfixed_ptsnum_per_pred_line = 50\neval_use_same_gt_sample_num_flag=True\nnum_map_classes = len(map_classes)\n\'> </span>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/icurb_dataset.py</p><span class=\'hidden-code\' data-code=\'@DATASETS.register_module()\nclass iCurb_Dataset(Dataset):\n    CLASSES = (\'curb\')\n    def __init__(self, split_file,seq_dir, image_dir, mask_dir, points_nums, map_classes=None, pipeline=None,mode="valid", test_mode=False):\n        assert mode in {"train", "valid", "test"}\n        self.MAPCLASSES = self.get_map_classes(map_classes)                            # [\'curb\']\n        annotation_dict = self.`load_datadir`(split_file, seq_dir, image_dir, mode)\n        self.annotation_dict = annotation_dict\n        self.seq_len = len(annotation_dict)                                            # 20236\n        self.points_nums = points_nums                                                 # 50\n        self.padding_value = -10000                                                    \n        self.mask_dir = mask_dir                        # \'./data/nyc/labels/binary_map\'     \n        self.total_acc = 0\n        self.total_recall = 0\n        self.total_r_f = 0\n        self.NUM_MAPCLASSES = len(self.MAPCLASSES)      # 1\n        if pipeline is not None:\n            self.pipeline = Compose(pipeline)           # {\'type\': \'LoadImageFromFiles\', \'to_float32\': True}   {\'type\': \'Collect\', \'keys\': [\'img\'], \'meta_keys\': \n        if not test_mode:\n            self._set_group_flag()                      # self.flag,长度为(20236,)的全0 numpy\n    def load_datadir(self, split_file, seq_path, image_path, mode):\n        with open(split_file,\'r\') as jf:                             # \'./data/nyc/data_split.json\'\n            json_list = json.load(jf)                                # {\'train\':[\'917137_12\',...], \'valid\':[\'042247_00\',...], \'test\':, \'pretrain\':}\n        train_list = json_list[\'train\'] + json_list[\'pretrain\']      # 20236\n        test_list = json_list[\'valid\']                               # 1770\n        val_list = json_list[\'valid\']\n        if mode == \'valid\':\n            json_list = [x+\'.json\' for x in val_list]\n        elif mode == \'test\':\n            json_list = [x+\'.json\' for x in test_list]\n        else:\n            json_list = [x+\'.json\' for x in train_list]\n        annotation_dict={}\n        for jsonf in json_list[:20]:\n            with open(osp.join(seq_path, jsonf), \'r\') as f:\n                seq_list = json.load(f)                               # 见readme.md  \n            instances= []\n            for area in seq_list: \n                instances.append(area[\'seq\'])                         # [[[512,0],...,[999,597]],[[543,0],...,[999,540]]]\n            annotation_dict.update({jsonf:{\'image_path\':osp.join(image_path, jsonf[:-4]+\'tiff\'),\'instances\':instances}})      # 轨迹路线\n        return annotation_dict   \n    def __getitem__(self, idx):\n        example = self.`load_data`(**list(self.annotation_dict.values())[idx])      # {\'image_path\': \'./data/nyc/cropped_t...37_12.tiff\', \'instances\': [[...], [...]]}\n        return example                                                            # <projects.mmdet3d_plugin.datasets.icurb_dataset.InstanceLines\n\'> </span>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/icurb_dataset.py</p><span class=\'hidden-code\' data-code=\'@DATASETS.register_module()\nclass iCurb_Dataset(Dataset):\n    def load_data(self, image_path, instances):\n        # load image    LoadImageFromFiles:  projects/mmdet3d_plugin/datasets/pipelines/load.py  Collect:                                             \n        example = self.`pipeline`({\'img_filename\':image_path})          # \'./data/nyc/cropped_tiff/917137_12.tiff\'  --->example-{\'img_metas\':,\'img\':(4, 1000, 1000)}\n        # load vectormap\n        example = self.`vectormap_pipeline`(example, instances)         # iCurb_Dataset.vectormap_pipeline\n        return example\n\'> </span>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/pipelines/load.py</p><span class=\'hidden-code\' data-code=\'class LoadImageFromFiles(object):\n    def __call__(self, results):\n        filename = results[\'img_filename\']            # \'./data/nyc/cropped_tiff/917137_12.tiff\'\n        img = Image.open(filename)                    # (1000, 1000)\n        img = F.to_tensor(img).numpy()                # (4, 1000, 1000)\n        img_shape = img.shape\n        h = img_shape[1]\n        w = img_shape[2]\n        size = (h, w)\n        if self.to_float32:\n            img = img.astype(np.float32)\n        results[\'filename\'] = filename\n        results[\'img\'] = img\n        results[\'img_shape\'] = size\n        results[\'ori_shape\'] = size\n        results[\'pad_shape\'] = size\n        results[\'scale_factor\'] = 1.0\n        num_channels = 1 if len(img.shape) < 3 else img.shape[0]\n        results[\'img_norm_cfg\'] = dict(mean=np.zeros(num_channels, dtype=np.float32),std=np.ones(num_channels, dtype=np.float32),to_rgb=False)\n        return results\n\'> </span>'}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/icurb_dataset.py</p><span class=\'hidden-code\' data-code=\'class iCurb_Dataset(Dataset):\n    def vectormap_pipeline(self, example, instances):\n        vectormap = `VectorizedLocalMap`(patch_size=example[\'img_metas\'].data[\'img_shape\'],map_classes=self.MAPCLASSES,fixed_ptsnum_per_line=self.points_nums,padding_value=self.padding_value,)\n        anns_results = vectormap.`gen_vectorized_samples`(instances=instances)  # anns_results, type: dict\n                                                                                # \'gt_vecs_pts_loc\': list[num_vecs], vec with num_points*2 coordinates\n                                                                                # \'gt_vecs_pts_num\': list[num_vecs], vec with num_points\n                                                                                # \'gt_vecs_label\': list[num_vecs], vec with cls index\n        gt_vecs_label = to_tensor(anns_results[\'gt_vecs_label\'])                # tensor([0, 0])\n        if isinstance(anns_results[\'gt_vecs_pts_loc\'], InstanceLines):          # True\n            gt_vecs_pts_loc = anns_results[\'gt_vecs_pts_loc\']                   # `<`projects.mmdet3d_plugin.datasets.icurb_dataset.InstanceLines object at 0x7fe49b278130`>`\n        else:\n            ......\n        example[\'gt_labels\'] = DC(gt_vecs_label, cpu_only=False)\n        example[\'gt_bboxes\'] = DC(gt_vecs_pts_loc, cpu_only=True)\n        return example\n\'> </span>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/icurb_dataset.py</p><span class=\'hidden-code\' data-code=\'class VectorizedLocalMap(object):\n    def __init__(self,patch_size,map_classes=[\'divider\',\'ped_crossing\',\'boundary\'],sample_dist=1,num_samples=250,padding=False,fixed_ptsnum_per_line=-1,padding_value=-10000):\n        super().__init__()\n        self.vec_classes = map_classes                # [\'curb\']\n        self.sample_dist = sample_dist                # 1\n        self.num_samples = num_samples                # 250\n        self.padding = padding                        # False\n        self.fixed_num = fixed_ptsnum_per_line        # 50\n        self.padding_value = padding_value            # -10000\n        self.patch_size = patch_size                  # (1000, 1000)\n    def gen_vectorized_samples(self, instances):      # [[[[512, 0]],...,[999, 597]],[[[543, 0],...,[999, 540]]]]\n        vectors = []\n        for instance in instances:                    # [[[512, 0]],...,[999, 597]]\n            vectors.append((LineString(np.array(instance)), 0)) \n        gt_labels = []\n        gt_instance = []\n        for instance, instance_type in vectors:\n            if instance_type != -1:\n                gt_instance.append(instance)\n                gt_labels.append(instance_type)\n        gt_instance = InstanceLines(gt_instance, gt_labels, self.sample_dist, self.num_samples, self.padding, self.fixed_num,self.padding_value, patch_size=self.patch_size)\n        # ----------------自己加的测试代码-----------------------\n        _ = gt_instance.start_end_points\n        _ = gt_instance.bbox\n        # _ = gt_instance.origin_points\n        _ = gt_instance.shift_fixed_num_sampled_points_v2\n        # ------------------------------------------------------\n        anns_results = dict(\n            gt_vecs_pts_loc=gt_instance,\n            gt_vecs_label=gt_labels,\n        )\n        return anns_results\n\'> </span>'}]}]}]}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">sd_data_line(projects/configs/vma_res152_e80_line.py)</p><span class=\'hidden-code\' data-code=\'lane_direction = [\'unidirectional\', \'bidirectional\', \'unknown\']                             “单向”、“双向”、“未知”\nlane_type = [\'solid\', \'dotted\', \'solid_fishbone\', \'ldotted_fishbone\', \'unknown\', \'no\']      “实心”、“虚线”\nlane_properties = [\'general\', \'stay\', \'tide\', \'bus\', \'three_color\', \'unknown\']\nlane_flag = [\'single\', \'double\', \'triple\', \'unknown\']                                       “单”、“双”、“三”、“未知”\nlane_width = [\'normal\', \'wide\', \'unknown\']\ncurb_type = [\'groundside\', \'roadside\', \'cone\', \'water_horse\', \'guardrail\',\'unknown\']        “圆形边”、“路边”、“锥形”、“水_霍斯”、“护栏”、“未知”\nattrs_dict = {\'lane_direction\':lane_direction, \'lane_type\':lane_type, \'lane_properties\':lane_properties, \'lane_flag\':lane_flag,\'lane_width\':lane_width, \'curb_type\':curb_type}\nfixed_ptsnum_per_gt_line = 50                              now only support fixed_pts > 0\nfixed_ptsnum_per_pred_line = 50\neval_use_same_gt_sample_num_flag=True\nnum_map_classes = len(map_classes)\n\'> </span>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/sd_driving_line_dataset.py</p><span class=\'hidden-code\' data-code=\'@DATASETS.register_module()\nclass SD_Driving_Line_Dataset(Dataset):\n    def __init__(......):\n        assert mode in {"train", "test", "valid"}\n        self.MAPCLASSES = self.CLASSES = self.get_map_classes(map_classes)  # [\'lane\', \'curb\', \'stopline\']-->[\'lane\', \'curb\', \'stopline\']\n        self.attrs_dict = attrs_dict               # {\'lane_direction\': [\'unidirectional\', \'bidirectional\', \'unknown\'], \'lane_type\': [...],...}\n        self.data_root = data_root                 # \'data/sd_data/line/cropped_data\'       这里面图片被切成了1000*1000大小的图片，\n        self.sub_dir = sub_dir                     # \'trajectory_cropped_images\'\n        annotation_dict = self.`load_datadir`(annotation_file, mode)\n        self.annotation_dict = annotation_dict\n        self.mask_dir = mask_dir                   # \'data/sd_data/line/cropped_data/mask_map\'\n        self.seq_len = len(annotation_dict)        # 35\n        self.points_nums = points_nums             # 50\n        self.padding_value = -10000   \n        self.NUM_MAPCLASSES = len(self.MAPCLASSES)  # 3\n        self.eval_use_same_gt_sample_num_flag=eval_use_same_gt_sample_num_flag   # True\n        self.test_mode = test_mode\n        if pipeline is not None:\n            self.pipeline = Compose(pipeline)   # \'LoadImageFromFiles\',\'NormalizeImage\',\'Collect\'\n        if not test_mode:\n            self.`_set_group_flag`()              # self.flag = np.zeros(len(self), dtype=np.uint8)\n\'> </span>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/sd_driving_line_dataset.py</p><span class=\'hidden-code\' data-code=\'class SD_Driving_Line_Dataset(Dataset):\n    def load_datadir(self, annotation_file, mode):\n        annotation_file = os.path.join(self.data_root, annotation_file)   # \'data/sd_data/line/cropped_data/sd_data_line_dict.json\'\n        with open(annotation_file,\'r\') as jf:\n            json_dict = json.load(jf)         # {"train":[{\'image_name\':\'sample_1_0.jpg\', \'left_top\': [2415, 0],\'instances\' =:[{\'class\':\'lane\',\'data\':[[],...,],"attr":{}}]}\n        if mode == \'valid\':\n            json_list = json_dict[\'valid\']\n        elif mode == \'test\':\n            json_list = json_dict[\'valid\']\n        else:\n            json_list = json_dict[\'train\']\n        annotation_dict={}\n        for img_ann in json_list:\n            annotation_dict.update({img_ann[\'image_name\']:{\'image_path\':osp.join(self.data_root, self.sub_dir, img_ann[\'image_name\']),\'instances\':img_ann[\'instances\']}})\n        return annotation_dict    # {\'sample_1_0.jpg\':{"iamge_path":"","instances":[{},{}]}}\n\'> </span>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/sd_driving_line_dataset.py</p><span class=\'hidden-code\' data-code=\'class SD_Driving_Line_Dataset(Dataset):\n    def __getitem__(self, idx):\n        if self.test_mode:\n            return self.prepare_test_data(idx)\n        while True:\n            data = self.`prepare_train_data`(idx)\n            if data is None:\n                idx = self._rand_another(idx)\n                continue\n            return data\n\'> </span>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/sd_driving_line_dataset.py</p><span class=\'hidden-code\' data-code=\'class SD_Driving_Line_Dataset(Dataset):\n    def prepare_train_data(self,idx):\n        return self.`load_train_data`(**list(self.annotation_dict.values())[idx])\n\'> </span>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/sd_driving_line_dataset.py</p><span class=\'hidden-code\' data-code=\'class SD_Driving_Line_Dataset(Dataset):\n    def load_train_data(self, image_path, instances):\n        example = self.`pipeline`({\'img_filename\':image_path})  # load image    \'data/....../sample_1_0.jpg\'\n        example = self.`vectormap_pipeline`(example, instances) # load vectormap [{\'class\': \'lane\', \'data\':[],\'attrs\':{}},{},......]\n        return example\n\'> </span>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/pipelines/load.py</p><span class=\'hidden-code\' data-code=\'class LoadImageFromFiles(object):\n\'> </span>'}, {'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/pipelines/load.py</p><span class=\'hidden-code\' data-code=\'class NormalizeImage(object):\n    def __call__(self, results):\n        img = results[\'img\'].transpose(1, 2, 0)     # C,H,W -> H,W,C\n        results[\'img\'] = mmcv.imnormalize(img, self.mean, self.std, self.to_rgb).transpose(2, 0, 1)\n        results[\'img_norm_cfg\'] = dict(\n            mean=self.mean, std=self.std, to_rgb=self.to_rgb)\n        return results\n\'> </span>'}, {'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">projects/mmdet3d_plugin/datasets/sd_driving_line_dataset.py</p><span class=\'hidden-code\' data-code=\'class SD_Driving_Line_Dataset(Dataset):\n    def vectormap_pipeline(self, example, instances):\n        vectormap = `VectorizedLocalMap`(patch_size=example[\'img_metas\'].data[\'img_shape\'], \n                                        map_classes=self.MAPCLASSES, \n                                        fixed_ptsnum_per_line=self.points_nums,\n                                        padding_value=self.padding_value,)\n        anns_results = vectormap.`gen_vectorized_samples`(instances, self.attrs_dict)\n        \n        \'\'\'\n        anns_results, type: dict\n            \'gt_vecs_pts_loc\': list[num_vecs], vec with num_points*2 coordinates\n            \'gt_vecs_pts_num\': list[num_vecs], vec with num_points\n            \'gt_vecs_label\': list[num_vecs], vec with cls index\n        \'\'\'\n        gt_vecs_label = to_tensor(anns_results[\'gt_vecs_label\'])\n        gt_vecs_attr = to_tensor(anns_results[\'gt_vecs_attr\']).permute(1, 0)\n        if isinstance(anns_results[\'gt_vecs_pts_loc\'], InstanceLines):\n            gt_vecs_pts_loc = anns_results[\'gt_vecs_pts_loc\']\n        else:\n            gt_vecs_pts_loc = to_tensor(anns_results[\'gt_vecs_pts_loc\'])\n            try:\n                gt_vecs_pts_loc = gt_vecs_pts_loc.flatten(1).to(dtype=torch.float32)\n            except:\n                # empty tensor, will be passed in train,  but we preserve it for test\n                gt_vecs_pts_loc = gt_vecs_pts_loc\n        example[\'gt_labels\'] = DC(gt_vecs_label, cpu_only=False)\n        example[\'gt_bboxes\'] = DC(gt_vecs_pts_loc, cpu_only=True)\n        example[\'gt_attrs\'] = DC(gt_vecs_attr, cpu_only=False)\n        return example\n\'> </span>'}]}]}]}]}]})</script>
    <script src='https://study1994.github.io/study_html/npm/myjs/tooltip.js'></script>
  </body>
</html>
