<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>pnp_det数据处理过程</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/prism.css"><link rel="stylesheet" href="https://study1994.github.io/study_html/npm/markmap-toolbar@0.13.5/dist/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/d3@6.7.0"></script>
    <script src="https://study1994.github.io/study_html/npm/markmap-view@0.13.5"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">数据处理</p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/loading.py</p><font size="0"><pre class="language-python"><code class="language-python">class LoadImageFromFile3D(LoadImageFromFile):\n    def __call__(self, results):\n        results = super(LoadImageFromFile3D, self).__call__(results)\n        if \'cam_intrinsic\' in results[\'img_info\']:\n            results[\'cam_intrinsic\'] = results[\'img_info\'][\'cam_intrinsic\']    <span style=\'color: red\'># 获取cam_intrinsic</span>\n        if self.with_img_dense_x2d:\n            results = self._gen_img_dense_x2d(results)\n        if \'cam_id\' in results[\'img_info\']:                     <span style=\'color: red\'># self.with_depth=False; cam_id->0</span>\n            results[\'cam_id\'] = results[\'img_info\'][\'cam_id\']\n        return results\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/loading.py</p><font size="0"><pre class="language-python"><code class="language-python">class LoadImageFromFile3D(LoadImageFromFile):\n    def _gen_img_dense_x2d(results):\n        h, w = results[\'img_shape\'][:2]\n        img_dense_x2d = np.mgrid[:h, :w].astype(np.float32)              <span style=\'color: red\'># (2, 900, 1600)</span>\n        img_dense_x2d[[1, 0]] = img_dense_x2d[[0, 1]]                    <span style=\'color: red\'># to [u, v]</span>\n        results[\'img_dense_x2d\'] = np.moveaxis(img_dense_x2d, 0, -1)     <span style=\'color: red\'># (H, W, 2)</span>\n        results[\'img_dense_x2d_mask\'] = np.ones((h, w, 1), dtype=np.float32)\n        return results\n</code></pre></font>\nimg_dense_x2d=np.mgrid[:3, :4].astype(np.float32)<br>\n<font size="0"><pre class="language-python"><code class="language-python">array([[[0., 0., 0., 0.],\n        [1., 1., 1., 1.],\n        [2., 2., 2., 2.]],\n       [[0., 1., 2., 3.],\n        [0., 1., 2., 3.],\n        [0., 1., 2., 3.]]], dtype=float32)\n</code></pre></font>\nimg_dense_x2d[[1, 0]] = img_dense_x2d[[0, 1]]<br>\n<font size="0"><pre class="language-python"><code class="language-python">array([[[0., 1., 2., 3.],\n        [0., 1., 2., 3.],\n        [0., 1., 2., 3.]],\n       [[0., 0., 0., 0.],\n        [1., 1., 1., 1.],\n        [2., 2., 2., 2.]]], dtype=float32)\n</code></pre></font>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/loading.py</p><font size="0"><pre class="language-python"><code class="language-python">class LoadAnnotations3D(LoadAnnotations):\n    def __call__(self, results):\n        results = super(LoadAnnotations3D, self).__call__(results)\n        if self.with_bbox_3d:\n            results = self._load_bboxes_3d(results)\n        if self.with_coord_3d:\n            results = self._load_coord_3d(results)\n        if self.with_truncation:\n            results[\'truncation\'] = results[\'ann_info\'][\'truncation\']\n        if self.with_attr:\n            results[\'gt_attr\'] = results[\'ann_info\'][\'attr\']\n        if self.with_velo:\n            results[\'gt_velo\'] = results[\'ann_info\'][\'velo\']\n        return results\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/loading.py</p><font size="0"><pre class="language-python"><code class="language-python">class LoadAnnotations3D(LoadAnnotations):\n    def _load_coord_3d(results):\n        crd_dict = mmcv.load(osp.join(results[\'coord_3d_prefix\'], results[\'ann_info\'][\'coord_3d\']))  <span style=\'color: red\'># data/nuscenes/oc_maps/n015-2018-07-18-11-07-57+0800__CAM_FRONT__1531883530412470__OC.pkl</span>\n        if \'coord_3d_rot\' in results[\'ann_info\']:                   <span style=\'color: red\'># nuscenes</span>\n            x3d_rot = results[\'ann_info\'][\'coord_3d_rot\'].T         <span style=\'color: red\'># x3d_rot = array([[ 1.,  0.,  0.], [ 0.,  0.,  1.], [ 0., -1.,  0.]], dtype=float32)</span>\n        else:\n            x3d_rot = None\n        gt_x3d = []\n        gt_x2d = []\n        for i, bbox_3d in zip(results[\'ann_info\'][\'object_ids\'],results[\'ann_info\'][\'bboxes_3d\']):\n            x2d = crd_dict[\'uv_list\'][i].astype(np.float32)\n            x3d = crd_dict[\'oc_list\'][i].astype(np.float32)\n            if x3d_rot is not None:              <span style=\'color: red\'># nuscenes</span>\n                x3d = x3d @ x3d_rot              <span style=\'color: red\'># 用到了x3d = x3d @ x3d_rot</span>\n            else:                                <span style=\'color: red\'># KITTI</span>\n                bh = bbox_3d[1]\n                x3d[:, 1] += bh / 2\n            gt_x3d.append(x3d)\n            gt_x2d.append(x2d)\n        results[\'gt_x3d\'] = gt_x3d\n        results[\'gt_x2d\'] = gt_x2d\n        return results\n</code></pre></font>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/transforms.py</p><font size="0"><pre class="language-python"><code class="language-python">class RandomFlip3D(RandomFlip):\n    def __call__(self, results):\n        results = super().__call__(results)  <span style=\'color: red\'># 对\'img\'，\'gt_bboxes_ignore\', \'gt_bboxes\'进行翻转</span>\n        if results[\'flip\']:\n            for key in results.get(\'dense_fields\', []):  <span style=\'color: red\'># 对\'img_dense_x2d\', \'img_dense_x2d_mask\'进行翻转</span>\n        return results                       <span style=\'color: red\'># 注意没对3Dbox进行翻转</span>\n</code></pre></font>'}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/transforms.py</p><font size="0"><pre class="language-python"><code class="language-python">class Crop3D(object):\n    def __call__(self, results):\n        return crop_3d(...)\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/transforms.py</p><font size="0"><pre class="language-python"><code class="language-python">def crop_3d(results, crop_box, bbox2mask, bbox2label, bbox2bbox_3d,allow_negative_crop=False, trunc_ignore_thres=-1.0):\n    crop_x1, crop_y1, crop_x2, crop_y2 = crop_box       <span style=\'color: red\'># results.get(\'dense_fields\', [])=[\'img_dense_x2d\', \'img_dense_x2d_mask\'] crop_box=(0, 228, 1600, 900)-->砍掉了上面的228</span>\n    <span style=\'color: red\'># crop the image</span>\n    img = results[\'img\']\n    img = img[crop_y1:crop_y2, crop_x1:crop_x2, ...]\n    img_shape = img.shape\n    results[\'img\'] = img\n    results[\'img_shape\'] = img_shape\n    <span style=\'color: red\'># offset bboxes and crop masks</span>\n    for key in results.get(\'bbox_fields\', []):                 <span style=\'color: red\'># results.get(\'bbox_fields\', [])=[\'gt_bboxes_ignore\', \'gt_bboxes\']</span>\n        <span style=\'color: red\'># e.g. gt_bboxes and gt_bboxes_ignore</span>\n        bbox_offset = np.array([crop_x1, crop_y1, crop_x1, crop_y1], dtype=np.float32)\n        results[key] = results[key] - bbox_offset\n        <span style=\'color: red\'># crop mask fields, e.g. gt_masks and gt_masks_ignore</span>\n        mask_key = bbox2mask.get(key)\n        if mask_key in results:\n            results[mask_key] = results[mask_key].crop(np.asarray([crop_x1, crop_y1, crop_x2, crop_y2]))\n    <span style=\'color: red\'># clip to the image boundary, set valid inds, move the truncated to ignore</span>\n    for key in results.get(\'bbox_fields\', []):\n        bboxes_ori = results[key]\n        bboxes = np.empty_like(bboxes_ori)\n        bboxes[:, 0::2] = np.clip(bboxes_ori[:, 0::2], 0, img_shape[1])\n        bboxes[:, 1::2] = np.clip(bboxes_ori[:, 1::2], 0, img_shape[0])\n        valid_inds = (bboxes[:, 2] > bboxes[:, 0]) & (bboxes[:, 3] > bboxes[:, 1])\n        <span style=\'color: red\'># If the crop does not contain any gt-bbox area and allow_negative_crop is False, skip this image.</span>\n        if (key == \'gt_bboxes\' and not valid_inds.any() and not allow_negative_crop):\n            return None\n        if key == \'gt_bboxes\' and trunc_ignore_thres > 0:\n            bboxes_ori_area = np.prod(bboxes_ori[:, 2:] - bboxes_ori[:, :2], axis=1)         <span style=\'color: red\'># bboxes_ori_area=array([85383.88], dtype=float32)</span>\n            if \'truncation\' in results:\n                truncation = np.array(results[\'truncation\'], dtype=np.float32)\n                bboxes_ori_area /= (1 - truncation).clip(min=1e-4)                           <span style=\'color: red\'># bboxes_ori_area=array([97027.14], dtype=float32)</span>\n            bboxes_aera = np.prod(bboxes[:, 2:] - bboxes[:, :2], axis=1)\n            ignore_inds = bboxes_aera < (1 - trunc_ignore_thres) * bboxes_ori_area            <span style=\'color: red\'># trunc_ignore_thres=0.8--如果切掉之后的2Dbox的面积小于原先的0.8，则为gignore</span>\n            ignore_inds = valid_inds & ignore_inds\n            <span style=\'color: red\'># disgard ignore from valid gt</span>\n        results[key] = bboxes[valid_inds, :]\n        <span style=\'color: red\'># label fields. e.g. gt_labels and gt_labels_ignore</span>\n        label_key = bbox2label.get(key)\n        if label_key in results:\n            results[label_key] = results[label_key][valid_inds]\n        <span style=\'color: red\'># mask fields, e.g. gt_masks and gt_masks_ignore</span>\n        mask_key = bbox2mask.get(key)\n        if mask_key in results:                                             <span style=\'color: red\'># mask_key=\'gt_masks\' not in results</span>\n            results[mask_key] = results[mask_key][valid_inds.nonzero()[0]]\n        <span style=\'color: red\'># bbox_3d fields</span>\n        bbox_3d_key = bbox2bbox_3d.get(key)\n        if bbox_3d_key in results:\n            results[bbox_3d_key] = results[bbox_3d_key][valid_inds]\n        if key == \'gt_bboxes\':\n            for misc_key in [\'gt_x2d\', \'gt_x3d\', \'truncation\', \'gt_attr\', \'gt_velo\']:\n                if misc_key in results:\n                    if isinstance(results[misc_key], list):\n                        results[misc_key] = [results[misc_key][i] for i in np.flatnonzero(valid_inds)]\n                    else:\n                        results[misc_key] = results[misc_key][valid_inds]\n    for key in results.get(\'dense_fields\', []):\n        dense = results[key]\n        if isinstance(dense, list):\n            results[key] = [\n                dense_single[crop_y1:crop_y2, crop_x1:crop_x2] for dense_single in dense]\n        else:\n            results[key] = dense[crop_y1:crop_y2, crop_x1:crop_x2]\n    return results\n</code></pre></font>'}]}]}]})</script></body>
</html>
