<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>pnp_det数据处理过程</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
.hidden-code {
  display: none !important;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/mycss/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/myjs/d3@6.7.0.js"></script>
    <script src="https://study1994.github.io/study_html/npm/myjs/markmap-view@0.13.5.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">数据处理</p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/loading.py</p><span class=\'hidden-code\' data-code=\'class LoadImageFromFile3D(LoadImageFromFile):\n    def __call__(self, results):\n        results = super(LoadImageFromFile3D, self).__call__(results)\n        if &amp;#39;cam_intrinsic&amp;#39; in results[&amp;#39;img_info&amp;#39;]:\n            results[&amp;#39;cam_intrinsic&amp;#39;] = results[&amp;#39;img_info&amp;#39;][&amp;#39;cam_intrinsic&amp;#39;]    # 获取cam_intrinsic\n        if self.with_img_dense_x2d:\n            results = self._gen_img_dense_x2d(results)\n        if &amp;#39;cam_id&amp;#39; in results[&amp;#39;img_info&amp;#39;]:                     # self.with_depth=False; cam_id->0\n            results[&amp;#39;cam_id&amp;#39;] = results[&amp;#39;img_info&amp;#39;][&amp;#39;cam_id&amp;#39;]\n        return results\n\'> </span>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/loading.py</p><span class=\'hidden-code\' data-code=\'class LoadImageFromFile3D(LoadImageFromFile):\n    def _gen_img_dense_x2d(results):\n        h, w = results[&amp;#39;img_shape&amp;#39;][:2]\n        img_dense_x2d = np.mgrid[:h, :w].astype(np.float32)              # (2, 900, 1600)\n        img_dense_x2d[[1, 0]] = img_dense_x2d[[0, 1]]                    # to [u, v]\n        results[&amp;#39;img_dense_x2d&amp;#39;] = np.moveaxis(img_dense_x2d, 0, -1)     # (H, W, 2)\n        results[&amp;#39;img_dense_x2d_mask&amp;#39;] = np.ones((h, w, 1), dtype=np.float32)\n        return results\n\'> </span>\nimg_dense_x2d=np.mgrid[:3, :4].astype(np.float32)<br>\n<span class=\'hidden-code\' data-code=\'array([[[0., 0., 0., 0.],\n        [1., 1., 1., 1.],\n        [2., 2., 2., 2.]],\n       [[0., 1., 2., 3.],\n        [0., 1., 2., 3.],\n        [0., 1., 2., 3.]]], dtype=float32)\n\'> </span>\nimg_dense_x2d[[1, 0]] = img_dense_x2d[[0, 1]]<br>\n<span class=\'hidden-code\' data-code=\'array([[[0., 1., 2., 3.],\n        [0., 1., 2., 3.],\n        [0., 1., 2., 3.]],\n       [[0., 0., 0., 0.],\n        [1., 1., 1., 1.],\n        [2., 2., 2., 2.]]], dtype=float32)\n\'> </span>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/loading.py</p><span class=\'hidden-code\' data-code=\'class LoadAnnotations3D(LoadAnnotations):\n    def __call__(self, results):\n        results = super(LoadAnnotations3D, self).__call__(results)\n        if self.with_bbox_3d:\n            results = self._load_bboxes_3d(results)\n        if self.with_coord_3d:\n            results = self._load_coord_3d(results)\n        if self.with_truncation:\n            results[&amp;#39;truncation&amp;#39;] = results[&amp;#39;ann_info&amp;#39;][&amp;#39;truncation&amp;#39;]\n        if self.with_attr:\n            results[&amp;#39;gt_attr&amp;#39;] = results[&amp;#39;ann_info&amp;#39;][&amp;#39;attr&amp;#39;]\n        if self.with_velo:\n            results[&amp;#39;gt_velo&amp;#39;] = results[&amp;#39;ann_info&amp;#39;][&amp;#39;velo&amp;#39;]\n        return results\n\'> </span>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/loading.py</p><span class=\'hidden-code\' data-code=\'class LoadAnnotations3D(LoadAnnotations):\n    def _load_coord_3d(results):\n        crd_dict = mmcv.load(osp.join(results[&amp;#39;coord_3d_prefix&amp;#39;], results[&amp;#39;ann_info&amp;#39;][&amp;#39;coord_3d&amp;#39;]))  # data/nuscenes/oc_maps/n015-2018-07-18-11-07-57+0800__CAM_FRONT__1531883530412470__OC.pkl\n        if &amp;#39;coord_3d_rot&amp;#39; in results[&amp;#39;ann_info&amp;#39;]:                   # nuscenes\n            x3d_rot = results[&amp;#39;ann_info&amp;#39;][&amp;#39;coord_3d_rot&amp;#39;].T         # x3d_rot = array([[ 1.,  0.,  0.], [ 0.,  0.,  1.], [ 0., -1.,  0.]], dtype=float32)\n        else:\n            x3d_rot = None\n        gt_x3d = []\n        gt_x2d = []\n        for i, bbox_3d in zip(results[&amp;#39;ann_info&amp;#39;][&amp;#39;object_ids&amp;#39;],results[&amp;#39;ann_info&amp;#39;][&amp;#39;bboxes_3d&amp;#39;]):\n            x2d = crd_dict[&amp;#39;uv_list&amp;#39;][i].astype(np.float32)\n            x3d = crd_dict[&amp;#39;oc_list&amp;#39;][i].astype(np.float32)\n            if x3d_rot is not None:              # nuscenes\n                x3d = x3d @ x3d_rot              # 用到了x3d = x3d @ x3d_rot\n            else:                                # KITTI\n                bh = bbox_3d[1]\n                x3d[:, 1] += bh / 2\n            gt_x3d.append(x3d)\n            gt_x2d.append(x2d)\n        results[&amp;#39;gt_x3d&amp;#39;] = gt_x3d\n        results[&amp;#39;gt_x2d&amp;#39;] = gt_x2d\n        return results\n\'> </span>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/transforms.py</p><span class=\'hidden-code\' data-code=\'class RandomFlip3D(RandomFlip):\n    def __call__(self, results):\n        results = super().__call__(results)  # 对&amp;#39;img&amp;#39;，&amp;#39;gt_bboxes_ignore&amp;#39;, &amp;#39;gt_bboxes&amp;#39;进行翻转\n        if results[&amp;#39;flip&amp;#39;]:\n            for key in results.get(&amp;#39;dense_fields&amp;#39;, []):  # 对&amp;#39;img_dense_x2d&amp;#39;, &amp;#39;img_dense_x2d_mask&amp;#39;进行翻转\n        return results                       # 注意没对3Dbox进行翻转\n\'> </span>'}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/transforms.py</p><span class=\'hidden-code\' data-code=\'class Crop3D(object):\n    def __call__(self, results):\n        return crop_3d(...)\n\'> </span>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">epropnp_det/datasets/pipelines/transforms.py</p><span class=\'hidden-code\' data-code=\'def crop_3d(results, crop_box, bbox2mask, bbox2label, bbox2bbox_3d,allow_negative_crop=False, trunc_ignore_thres=-1.0):\n    crop_x1, crop_y1, crop_x2, crop_y2 = crop_box       # results.get(&amp;#39;dense_fields&amp;#39;, [])=[&amp;#39;img_dense_x2d&amp;#39;, &amp;#39;img_dense_x2d_mask&amp;#39;] crop_box=(0, 228, 1600, 900)-->砍掉了上面的228\n    # crop the image\n    img = results[&amp;#39;img&amp;#39;]\n    img = img[crop_y1:crop_y2, crop_x1:crop_x2, ...]\n    img_shape = img.shape\n    results[&amp;#39;img&amp;#39;] = img\n    results[&amp;#39;img_shape&amp;#39;] = img_shape\n    # offset bboxes and crop masks\n    for key in results.get(&amp;#39;bbox_fields&amp;#39;, []):                 # results.get(&amp;#39;bbox_fields&amp;#39;, [])=[&amp;#39;gt_bboxes_ignore&amp;#39;, &amp;#39;gt_bboxes&amp;#39;]\n        # e.g. gt_bboxes and gt_bboxes_ignore\n        bbox_offset = np.array([crop_x1, crop_y1, crop_x1, crop_y1], dtype=np.float32)\n        results[key] = results[key] - bbox_offset\n        # crop mask fields, e.g. gt_masks and gt_masks_ignore\n        mask_key = bbox2mask.get(key)\n        if mask_key in results:\n            results[mask_key] = results[mask_key].crop(np.asarray([crop_x1, crop_y1, crop_x2, crop_y2]))\n    # clip to the image boundary, set valid inds, move the truncated to ignore\n    for key in results.get(&amp;#39;bbox_fields&amp;#39;, []):\n        bboxes_ori = results[key]\n        bboxes = np.empty_like(bboxes_ori)\n        bboxes[:, 0::2] = np.clip(bboxes_ori[:, 0::2], 0, img_shape[1])\n        bboxes[:, 1::2] = np.clip(bboxes_ori[:, 1::2], 0, img_shape[0])\n        valid_inds = (bboxes[:, 2] > bboxes[:, 0]) &amp; (bboxes[:, 3] > bboxes[:, 1])\n        # If the crop does not contain any gt-bbox area and allow_negative_crop is False, skip this image.\n        if (key == &amp;#39;gt_bboxes&amp;#39; and not valid_inds.any() and not allow_negative_crop):\n            return None\n        if key == &amp;#39;gt_bboxes&amp;#39; and trunc_ignore_thres > 0:\n            bboxes_ori_area = np.prod(bboxes_ori[:, 2:] - bboxes_ori[:, :2], axis=1)         # bboxes_ori_area=array([85383.88], dtype=float32)\n            if &amp;#39;truncation&amp;#39; in results:\n                truncation = np.array(results[&amp;#39;truncation&amp;#39;], dtype=np.float32)\n                bboxes_ori_area /= (1 - truncation).clip(min=1e-4)                           # bboxes_ori_area=array([97027.14], dtype=float32)\n            bboxes_aera = np.prod(bboxes[:, 2:] - bboxes[:, :2], axis=1)\n            ignore_inds = bboxes_aera < (1 - trunc_ignore_thres) * bboxes_ori_area            # trunc_ignore_thres=0.8--如果切掉之后的2Dbox的面积小于原先的0.8，则为gignore\n            ignore_inds = valid_inds &amp; ignore_inds\n            # disgard ignore from valid gt\n        results[key] = bboxes[valid_inds, :]\n        # label fields. e.g. gt_labels and gt_labels_ignore\n        label_key = bbox2label.get(key)\n        if label_key in results:\n            results[label_key] = results[label_key][valid_inds]\n        # mask fields, e.g. gt_masks and gt_masks_ignore\n        mask_key = bbox2mask.get(key)\n        if mask_key in results:                                             # mask_key=&amp;#39;gt_masks&amp;#39; not in results\n            results[mask_key] = results[mask_key][valid_inds.nonzero()[0]]\n        # bbox_3d fields\n        bbox_3d_key = bbox2bbox_3d.get(key)\n        if bbox_3d_key in results:\n            results[bbox_3d_key] = results[bbox_3d_key][valid_inds]\n        if key == &amp;#39;gt_bboxes&amp;#39;:\n            for misc_key in [&amp;#39;gt_x2d&amp;#39;, &amp;#39;gt_x3d&amp;#39;, &amp;#39;truncation&amp;#39;, &amp;#39;gt_attr&amp;#39;, &amp;#39;gt_velo&amp;#39;]:\n                if misc_key in results:\n                    if isinstance(results[misc_key], list):\n                        results[misc_key] = [results[misc_key][i] for i in np.flatnonzero(valid_inds)]\n                    else:\n                        results[misc_key] = results[misc_key][valid_inds]\n    for key in results.get(&amp;#39;dense_fields&amp;#39;, []):\n        dense = results[key]\n        if isinstance(dense, list):\n            results[key] = [\n                dense_single[crop_y1:crop_y2, crop_x1:crop_x2] for dense_single in dense]\n        else:\n            results[key] = dense[crop_y1:crop_y2, crop_x1:crop_x2]\n    return results\n\'> </span>'}]}]}]})</script><script src='https://study1994.github.io/study_html/npm/myjs/tooltip.js'></script>
</body>
</html>
