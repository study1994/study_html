<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>yolov10数据处理</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/prism.css"><link rel="stylesheet" href="https://study1994.github.io/study_html/npm/markmap-toolbar@0.13.5/dist/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/d3@6.7.0"></script>
    <script src="https://study1994.github.io/study_html/npm/markmap-view@0.13.5"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">训练ultralytics/data/dataset.py-rect=False</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class YOLODataset(BaseDataset):\n    def __init__(self, *args, data=None, task="detect", **kwargs):\n        self.use_segments = task == "segment"     <span style=\'color: red\'>False</span>\n        self.use_keypoints = task == "pose"       <span style=\'color: red\'>False</span>\n        self.use_obb = task == "obb"              <span style=\'color: red\'>False</span>\n        self.data = data\n        assert not (self.use_segments and self.use_keypoints), "Can not use both segments and keypoints."\n        super().<span style=\'color: green;font-weight: bold;\'>__init__</span>(*args, **kwargs)\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/base.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class BaseDataset(Dataset):\n    def __init__(self,img_path,imgsz=640,cache=False,augment=True,hyp=DEFAULT_CFG,prefix="",rect=False,\n    batch_size=16,stride=32,pad=0.5,single_cls=False,classes=None,fraction=1.0):\n        super().__init__()\n        ......\n        self.im_files = self.<span style=\'color: green;font-weight: bold;\'>get_img_files</span>(self.img_path)\n        self.labels = self.<span style=\'color: green;font-weight: bold;\'>get_labels</span>()\n        self.update_labels(include_class=classes)  <span style=\'color: red\'># single_cls and include_class</span>\n        if self.rect:\n            self.<span style=\'color: green;font-weight: bold;\'>set_rectangle</span>()\n        ......\n        <span style=\'color: red\'># Transforms</span>\n        self.transforms = self.<span style=\'color: green;font-weight: bold;\'>build_transforms</span>(hyp=hyp)\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/base.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class BaseDataset(Dataset):\n    def get_img_files(self, img_path):     <span style=\'color: red\'># img_path 可以为list或者单个  self.fraction<1时获取部分数据</span>\n</code></pre></font>'}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/dataset.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class YOLODataset(BaseDataset):\n    def get_labels(self):\n        self.label_files = <span style=\'color: green;font-weight: bold;\'>img2label_paths</span>(self.im_files)\n        cache_path = Path(self.label_files[0]).parent.with_suffix(".cache")\n        try:\n            cache, exists = load_dataset_cache_file(cache_path), True  <span style=\'color: red\'># attempt to load a *.cache file</span>\n            assert cache["version"] == DATASET_CACHE_VERSION  <span style=\'color: red\'># matches current version</span>\n            assert cache["hash"] == get_hash(self.label_files + self.im_files)  <span style=\'color: red\'># identical hash</span>\n        except (FileNotFoundError, AssertionError, AttributeError):\n            cache, exists = self.<span style=\'color: green;font-weight: bold;\'>cache_labels</span>(cache_path), False  <span style=\'color: red\'># run cache ops</span>\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/utils.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">def img2label_paths(img_paths):\n    sa, sb = f"{os.sep}images{os.sep}", f"{os.sep}labels{os.sep}"  <span style=\'color: red\'># /images/, /labels/ substrings</span>\n    return [sb.join(x.rsplit(sa, 1)).rsplit(".", 1)[0] + ".txt" for x in img_paths]\n</code></pre></font>'}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/dataset.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class YOLODataset(BaseDataset):\n    def cache_labels(self, path=Path("./labels.cache")):\n        pass\n</code></pre></font>'}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/base.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class BaseDataset(Dataset):\n    def set_rectangle(self):               <span style=\'color: red\'># Sets the shape of bounding boxes for YOLO detections as rectangles</span>\n        bi = np.floor(np.arange(self.ni) / self.batch_size).astype(int)  <span style=\'color: red\'># batch index</span>\n        nb = bi[-1] + 1                                                  <span style=\'color: red\'># number of batches</span>\n        s = np.array([x.pop("shape") for x in self.labels])              <span style=\'color: red\'># hw</span>\n        ar = s[:, 0] / s[:, 1]                                           <span style=\'color: red\'># aspect ratio</span>\n        irect = ar.argsort()\n        self.im_files = [self.im_files[i] for i in irect]\n        self.labels = [self.labels[i] for i in irect]\n        ar = ar[irect]\n        <span style=\'color: red\'># Set training image shapes</span>\n        shapes = [[1, 1]] * nb\n        for i in range(nb):\n            ari = ar[bi == i]\n            mini, maxi = ari.min(), ari.max()\n            if maxi < 1:\n                shapes[i] = [maxi, 1]\n            elif mini > 1:\n                shapes[i] = [1, 1 / mini]\n        self.batch_shapes = np.ceil(np.array(shapes) * self.imgsz / self.stride + self.pad).astype(int) * self.stride\n        self.batch = bi                    <span style=\'color: red\'># batch index of image</span>\n</code></pre></font>'}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/dataset.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class YOLODataset(BaseDataset):\n    def build_transforms(self, hyp=None):   <span style=\'color: red\'># Builds and appends transforms to the list</span>\n        if self.augment:\n            hyp.mosaic = hyp.mosaic if self.augment and not self.rect else 0.0      <span style=\'color: red\'># 1</span>\n            hyp.mixup = hyp.mixup if self.augment and not self.rect else 0.0        <span style=\'color: red\'># 0</span>\n            transforms = <span style=\'color: green;font-weight: bold;\'>v8_transforms</span>(self, self.imgsz, hyp)\n        else:\n            transforms = Compose([LetterBox(new_shape=(self.imgsz, self.imgsz), scaleup=False)])\n        transforms.append(\n            <span style=\'color: green;font-weight: bold;\'>Format</span>(bbox_format="xywh",normalize=True,return_mask=self.use_segments,return_keypoint=self.use_keypoints,return_obb=self.use_obb,\n                batch_idx=True,mask_ratio=hyp.mask_ratio,mask_overlap=hyp.overlap_mask,bgr=hyp.bgr if self.augment else 0.0,  <span style=\'color: red\'># only affect training.</span>\n            )\n        )\n        return transforms\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/augment.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">def v8_transforms(dataset, imgsz, hyp, stretch=False):          <span style=\'color: red\'># Convert images to a size suitable for YOLOv8 training</span>\n    pre_transform = Compose([\n            Mosaic(dataset, imgsz=imgsz, p=hyp.mosaic),\n            CopyPaste(p=hyp.copy_paste),\n            RandomPerspective(\n                degrees=hyp.degrees,\n                translate=hyp.translate,\n                scale=hyp.scale,\n                shear=hyp.shear,\n                perspective=hyp.perspective,\n                pre_transform=None if stretch else LetterBox(new_shape=(imgsz, imgsz)),\n            ),\n        ]\n    )\n    flip_idx = dataset.data.get("flip_idx", [])  <span style=\'color: red\'># for keypoints augmentation</span>\n    if dataset.use_keypoints:\n        ......\n    return Compose([\n            pre_transform,\n            MixUp(dataset, pre_transform=pre_transform, p=hyp.mixup),\n            Albumentations(p=1.0),\n            RandomHSV(hgain=hyp.hsv_h, sgain=hyp.hsv_s, vgain=hyp.hsv_v),\n            RandomFlip(direction="vertical", p=hyp.flipud),\n            RandomFlip(direction="horizontal", p=hyp.fliplr, flip_idx=flip_idx),\n        ]\n    )  <span style=\'color: red\'># transforms</span>\n</code></pre></font>'}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/augment.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class Format:\n    def __init__(self,bbox_format="xywh",normalize=True,return_mask=False,return_keypoint=False,\n      return_obb=False,mask_ratio=4,mask_overlap=True,batch_idx=True,bgr=0.0,):\n        self.bbox_format = bbox_format\n        self.normalize = normalize\n        self.return_mask = return_mask  <span style=\'color: red\'># set False when training detection only</span>\n        self.return_keypoint = return_keypoint\n        self.return_obb = return_obb\n        self.mask_ratio = mask_ratio\n        self.mask_overlap = mask_overlap\n        self.batch_idx = b\n</code></pre></font>'}]}]}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/base.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class BaseDataset(Dataset):\n    def __getitem__(self, index):             <span style=\'color: red\'>Returns transformed label information for given index</span>\n        <span style=\'color: red\'>[ultralytics.data.augment.Mosaic/CopyPaste/RandomPerspective],<span style=\'color: green;font-weight: bold;\'><</span>ultralytics.data.augment.MixUp/Albumentations/RandomHSV/RandomFlip/RandomFlip/Format/<span style=\'color: green;font-weight: bold;\'>></span></span>\n        return self.<span style=\'color: green;font-weight: bold;\'>transforms</span>(self.<span style=\'color: green;font-weight: bold;\'>get_image_and_label</span>(index))\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/augment.py</p><font size="0"><pre class="language-python" style="line-height: 0.01; "><code class="language-python">class Mosaic(BaseMixTransform):\n    def _mosaic4(self, labels):                     <span style=\'color: red\'># Create a 2x2 image mosaic</span>\n        mosaic_labels = []\n        if isinstance(self.imgsz, (list, tuple)):\n            s = self.imgsz                                                                          <span style=\'color: red\'># 【300,2*600-300】【480,2*960-480】=(300,900)(480,1440)</span>\n            yc, xc = (int(random.uniform(-x, 2 * s[idx] + x)) for idx,x in enumerate(self.border))  <span style=\'color: red\'># mosaic center x, y  </span>\n            for i in range(4):\n                labels_patch = labels if i == 0 else labels["mix_labels"][i - 1]\n                img = labels_patch["img"]                    <span style=\'color: red\'># Load image   (600, 960, 3)</span>\n                h, w = labels_patch.pop("resized_shape")     <span style=\'color: red\'># (600, 960, 3)</span>\n                if i == 0:  <span style=\'color: red\'># top left</span>\n                    img4 = np.full((s[0] * 2, s[1] * 2, img.shape[2]), 114, dtype=np.uint8)  <span style=\'color: red\'># base image with 4 tiles    (1200, 1920, 3)</span>\n                    x1a, y1a, x2a, y2a = max(xc - w, 0), max(yc - h, 0), xc, yc  <span style=\'color: red\'># xmin, ymin, xmax, ymax (large image)   0，0，960，640</span>\n                    x1b, y1b, x2b, y2b = w - (x2a - x1a), h - (y2a - y1a), w, h  <span style=\'color: red\'># xmin, ymin, xmax, ymax (small image)   0，0，960，640  padw=0，padh=0</span>\n                elif i == 1:  <span style=\'color: red\'># top right</span>\n                    x1a, y1a, x2a, y2a = xc, max(yc - h, 0), min(xc + w, s[1] * 2), yc      <span style=\'color: red\'># 960，0，1920，640</span>\n                    x1b, y1b, x2b, y2b = 0, h - (y2a - y1a), min(w, x2a - x1a), h           <span style=\'color: red\'># 0，0，960，640  padw=960，padh=0</span>\n                elif i == 2:  <span style=\'color: red\'># bottom left</span>\n                    x1a, y1a, x2a, y2a = max(xc - w, 0), yc, xc, min(s[0] * 2, yc + h)      <span style=\'color: red\'># 0, 600, 960, 1200</span>\n                    x1b, y1b, x2b, y2b = w - (x2a - x1a), 0, w, min(y2a - y1a, h)           <span style=\'color: red\'># 0, 0, 960, 600  padw=0，padh=600</span>\n                elif i == 3:  <span style=\'color: red\'># bottom right</span>\n                    x1a, y1a, x2a, y2a = xc, yc, min(xc + w, s[1] * 2), min(s[0] * 2, yc + h)  <span style=\'color: red\'># 960, 600, 1920, 1200</span>\n                    x1b, y1b, x2b, y2b = 0, 0, min(w, x2a - x1a), min(y2a - y1a, h)            <span style=\'color: red\'># 0, 0, 960, 600  padw=960，padh=600</span>\n                img4[y1a:y2a, x1a:x2a] = img[y1b:y2b, x1b:x2b]  <span style=\'color: red\'># img4[ymin:ymax, xmin:xmax]</span>\n                padw = x1a - x1b\n                padh = y1a - y1b\n                labels_patch = self._update_labels(labels_patch, padw, padh)\n                mosaic_labels.append(labels_patch)\n        else:\n            ......\n        final_labels = self._cat_labels(mosaic_labels)\n        final_labels["img"] = img4\n        return final_labels\n</code></pre></font>'}]}]})</script></body>
</html>
