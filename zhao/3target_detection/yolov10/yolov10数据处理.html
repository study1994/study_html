<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>yolov10数据处理</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
.hidden-code {
  display: none !important;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/mycss/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/myjs/d3@6.7.0.js"></script>
    <script src="https://study1994.github.io/study_html/npm/myjs/markmap-view@0.13.5.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">训练ultralytics/data/dataset.py-rect=False</p><span class=\'hidden-code\' data-code=\'class YOLODataset(BaseDataset):\n    def __init__(self, *args, data=None, task=&amp;#39;detect&amp;#39;, **kwargs):\n        self.use_segments = task == &amp;#39;segment&amp;#39;     False\n        self.use_keypoints = task == &amp;#39;pose&amp;#39;       False\n        self.use_obb = task == &amp;#39;obb&amp;#39;              False\n        self.data = data\n        assert not (self.use_segments and self.use_keypoints), &amp;#39;Can not use both segments and keypoints.&amp;#39;\n        super().`__init__`(*args, **kwargs)\n\'> </span>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/base.py</p><span class=\'hidden-code\' data-code=\'class BaseDataset(Dataset):\n    def __init__(self,img_path,imgsz=640,cache=False,augment=True,hyp=DEFAULT_CFG,prefix=&amp;#39;&amp;#39;,rect=False,\n    batch_size=16,stride=32,pad=0.5,single_cls=False,classes=None,fraction=1.0):\n        super().__init__()\n        ......\n        self.im_files = self.`get_img_files`(self.img_path)\n        self.labels = self.`get_labels`()\n        self.update_labels(include_class=classes)  # single_cls and include_class\n        if self.rect:\n            self.`set_rectangle`()\n        ......\n        # Transforms\n        self.transforms = self.`build_transforms`(hyp=hyp)\n\'> </span>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/base.py</p><span class=\'hidden-code\' data-code=\'class BaseDataset(Dataset):\n    def get_img_files(self, img_path):     # img_path 可以为list或者单个  self.fraction<1时获取部分数据\n\'> </span>'}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/dataset.py</p><span class=\'hidden-code\' data-code=\'class YOLODataset(BaseDataset):\n    def get_labels(self):\n        self.label_files = `img2label_paths`(self.im_files)\n        cache_path = Path(self.label_files[0]).parent.with_suffix(&amp;#39;.cache&amp;#39;)\n        try:\n            cache, exists = load_dataset_cache_file(cache_path), True  # attempt to load a *.cache file\n            assert cache[&amp;#39;version&amp;#39;] == DATASET_CACHE_VERSION  # matches current version\n            assert cache[&amp;#39;hash&amp;#39;] == get_hash(self.label_files + self.im_files)  # identical hash\n        except (FileNotFoundError, AssertionError, AttributeError):\n            cache, exists = self.`cache_labels`(cache_path), False  # run cache ops\n\'> </span>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/utils.py</p><span class=\'hidden-code\' data-code=\'def img2label_paths(img_paths):\n    sa, sb = f&amp;#39;{os.sep}images{os.sep}&amp;#39;, f&amp;#39;{os.sep}labels{os.sep}&amp;#39;  # /images/, /labels/ substrings\n    return [sb.join(x.rsplit(sa, 1)).rsplit(&amp;#39;.&amp;#39;, 1)[0] + &amp;#39;.txt&amp;#39; for x in img_paths]\n\'> </span>'}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/dataset.py</p><span class=\'hidden-code\' data-code=\'class YOLODataset(BaseDataset):\n    def cache_labels(self, path=Path(&amp;#39;./labels.cache&amp;#39;)):\n        pass\n\'> </span>'}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/base.py</p><span class=\'hidden-code\' data-code=\'class BaseDataset(Dataset):\n    def set_rectangle(self):               # Sets the shape of bounding boxes for YOLO detections as rectangles\n        bi = np.floor(np.arange(self.ni) / self.batch_size).astype(int)  # batch index\n        nb = bi[-1] + 1                                                  # number of batches\n        s = np.array([x.pop(&amp;#39;shape&amp;#39;) for x in self.labels])              # hw\n        ar = s[:, 0] / s[:, 1]                                           # aspect ratio\n        irect = ar.argsort()\n        self.im_files = [self.im_files[i] for i in irect]\n        self.labels = [self.labels[i] for i in irect]\n        ar = ar[irect]\n        # Set training image shapes\n        shapes = [[1, 1]] * nb\n        for i in range(nb):\n            ari = ar[bi == i]\n            mini, maxi = ari.min(), ari.max()\n            if maxi < 1:\n                shapes[i] = [maxi, 1]\n            elif mini > 1:\n                shapes[i] = [1, 1 / mini]\n        self.batch_shapes = np.ceil(np.array(shapes) * self.imgsz / self.stride + self.pad).astype(int) * self.stride\n        self.batch = bi                    # batch index of image\n\'> </span>'}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/dataset.py</p><span class=\'hidden-code\' data-code=\'class YOLODataset(BaseDataset):\n    def build_transforms(self, hyp=None):   # Builds and appends transforms to the list\n        if self.augment:\n            hyp.mosaic = hyp.mosaic if self.augment and not self.rect else 0.0      # 1\n            hyp.mixup = hyp.mixup if self.augment and not self.rect else 0.0        # 0\n            transforms = `v8_transforms`(self, self.imgsz, hyp)\n        else:\n            transforms = Compose([LetterBox(new_shape=(self.imgsz, self.imgsz), scaleup=False)])\n        transforms.append(\n            `Format`(bbox_format=&amp;#39;xywh&amp;#39;,normalize=True,return_mask=self.use_segments,return_keypoint=self.use_keypoints,return_obb=self.use_obb,\n                batch_idx=True,mask_ratio=hyp.mask_ratio,mask_overlap=hyp.overlap_mask,bgr=hyp.bgr if self.augment else 0.0,  # only affect training.\n            )\n        )\n        return transforms\n\'> </span>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/augment.py</p><span class=\'hidden-code\' data-code=\'def v8_transforms(dataset, imgsz, hyp, stretch=False):          # Convert images to a size suitable for YOLOv8 training\n    pre_transform = Compose([\n            Mosaic(dataset, imgsz=imgsz, p=hyp.mosaic),\n            CopyPaste(p=hyp.copy_paste),\n            RandomPerspective(\n                degrees=hyp.degrees,\n                translate=hyp.translate,\n                scale=hyp.scale,\n                shear=hyp.shear,\n                perspective=hyp.perspective,\n                pre_transform=None if stretch else LetterBox(new_shape=(imgsz, imgsz)),\n            ),\n        ]\n    )\n    flip_idx = dataset.data.get(&amp;#39;flip_idx&amp;#39;, [])  # for keypoints augmentation\n    if dataset.use_keypoints:\n        ......\n    return Compose([\n            pre_transform,\n            MixUp(dataset, pre_transform=pre_transform, p=hyp.mixup),\n            Albumentations(p=1.0),\n            RandomHSV(hgain=hyp.hsv_h, sgain=hyp.hsv_s, vgain=hyp.hsv_v),\n            RandomFlip(direction=&amp;#39;vertical&amp;#39;, p=hyp.flipud),\n            RandomFlip(direction=&amp;#39;horizontal&amp;#39;, p=hyp.fliplr, flip_idx=flip_idx),\n        ]\n    )  # transforms\n\'> </span>'}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/augment.py</p><span class=\'hidden-code\' data-code=\'class Format:\n    def __init__(self,bbox_format=&amp;#39;xywh&amp;#39;,normalize=True,return_mask=False,return_keypoint=False,\n      return_obb=False,mask_ratio=4,mask_overlap=True,batch_idx=True,bgr=0.0,):\n        self.bbox_format = bbox_format\n        self.normalize = normalize\n        self.return_mask = return_mask  # set False when training detection only\n        self.return_keypoint = return_keypoint\n        self.return_obb = return_obb\n        self.mask_ratio = mask_ratio\n        self.mask_overlap = mask_overlap\n        self.batch_idx = b\n\'> </span>'}]}]}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/base.py</p><span class=\'hidden-code\' data-code=\'class BaseDataset(Dataset):\n    def __getitem__(self, index):             Returns transformed label information for given index\n        [ultralytics.data.augment.Mosaic/CopyPaste/RandomPerspective],`<`ultralytics.data.augment.MixUp/Albumentations/RandomHSV/RandomFlip/RandomFlip/Format/`>`\n        return self.`transforms`(self.`get_image_and_label`(index))\n\'> </span>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">ultralytics/data/augment.py</p><span class=\'hidden-code\' data-code=\'class Mosaic(BaseMixTransform):\n    def _mosaic4(self, labels):                     # Create a 2x2 image mosaic\n        mosaic_labels = []\n        if isinstance(self.imgsz, (list, tuple)):\n            s = self.imgsz                                                                          # 【300,2*600-300】【480,2*960-480】=(300,900)(480,1440)\n            yc, xc = (int(random.uniform(-x, 2 * s[idx] + x)) for idx,x in enumerate(self.border))  # mosaic center x, y  \n            for i in range(4):\n                labels_patch = labels if i == 0 else labels[&amp;#39;mix_labels&amp;#39;][i - 1]\n                img = labels_patch[&amp;#39;img&amp;#39;]                    # Load image   (600, 960, 3)\n                h, w = labels_patch.pop(&amp;#39;resized_shape&amp;#39;)     # (600, 960, 3)\n                if i == 0:  # top left\n                    img4 = np.full((s[0] * 2, s[1] * 2, img.shape[2]), 114, dtype=np.uint8)  # base image with 4 tiles    (1200, 1920, 3)\n                    x1a, y1a, x2a, y2a = max(xc - w, 0), max(yc - h, 0), xc, yc  # xmin, ymin, xmax, ymax (large image)   0，0，960，640\n                    x1b, y1b, x2b, y2b = w - (x2a - x1a), h - (y2a - y1a), w, h  # xmin, ymin, xmax, ymax (small image)   0，0，960，640  padw=0，padh=0\n                elif i == 1:  # top right\n                    x1a, y1a, x2a, y2a = xc, max(yc - h, 0), min(xc + w, s[1] * 2), yc      # 960，0，1920，640\n                    x1b, y1b, x2b, y2b = 0, h - (y2a - y1a), min(w, x2a - x1a), h           # 0，0，960，640  padw=960，padh=0\n                elif i == 2:  # bottom left\n                    x1a, y1a, x2a, y2a = max(xc - w, 0), yc, xc, min(s[0] * 2, yc + h)      # 0, 600, 960, 1200\n                    x1b, y1b, x2b, y2b = w - (x2a - x1a), 0, w, min(y2a - y1a, h)           # 0, 0, 960, 600  padw=0，padh=600\n                elif i == 3:  # bottom right\n                    x1a, y1a, x2a, y2a = xc, yc, min(xc + w, s[1] * 2), min(s[0] * 2, yc + h)  # 960, 600, 1920, 1200\n                    x1b, y1b, x2b, y2b = 0, 0, min(w, x2a - x1a), min(y2a - y1a, h)            # 0, 0, 960, 600  padw=960，padh=600\n                img4[y1a:y2a, x1a:x2a] = img[y1b:y2b, x1b:x2b]  # img4[ymin:ymax, xmin:xmax]\n                padw = x1a - x1b\n                padh = y1a - y1b\n                labels_patch = self._update_labels(labels_patch, padw, padh)\n                mosaic_labels.append(labels_patch)\n        else:\n            ......\n        final_labels = self._cat_labels(mosaic_labels)\n        final_labels[&amp;#39;img&amp;#39;] = img4\n        return final_labels\n\'> </span>'}]}]})</script><script src='https://study1994.github.io/study_html/npm/myjs/tooltip.js'></script>
</body>
</html>
