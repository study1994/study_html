<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>pv_rcnn训练过程</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 150vw;
  height: 200vh;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/prism.css"><link rel="stylesheet" href="https://study1994.github.io/study_html/npm/markmap-toolbar@0.13.5/dist/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/d3@6.7.0"></script>
    <script src="https://study1994.github.io/study_html/npm/markmap-view@0.13.5"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>batch_dict = self.vfe(batch_dict)<br>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/vfe/mean_vfe.py:MeanVFE:def forward</p>\n<p>voxel_features, voxel_num_points=torch.Size([160000, 5, 4]);torch.Size([160000])<br>\n<code>voxel_features</code>points_mean=torch.Size([160000, 4])将每个voxel里面的点特征求均值<br></p>'}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>batch_dict = self.backbone_3d(batch_dict)<br>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/spconv_backbone.py:VoxelResBackBone8x:def forward</p>\n<p>voxel_features, voxel_coords=torch.Size([160000, 4]);torch.Size([160000, 4])<br>\nx=[61, 2048, 2048]<br>\n<code>multi_scale_3d_features</code>都是sparse tensor<br>\n<code>x_conv1</code>: x_conv1,[61, 2048, 2048]<br>\n<code>x_conv2</code>: x_conv2,[31, 1024, 1024] x2<br>\n<code>x_conv3</code>: x_conv3,[16, 512, 512]   x4<br>\n<code>x_conv4</code>: x_conv4,[7, 256, 256]    x8<br>\n<code>encoded_spconv_tensor</code>: out [3, 256, 256]  x8<br></p>'}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>batch_dict = self.map_to_bev_module(batch_dict)<br>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_2d/map_to_bev/height_compression.py:HeightCompression:def forward</p>\n<p>spatial_features=torch.Size([2, 128, 3, 256, 256])-》BN, C, D, H, W<br>\n<code>spatial_features</code>spatial_features通道和深度进行拼接:spatial_features-&gt;torch.Size([2, 384, 256, 256])<br>\n<code>spatial_features_stride</code>:8<br></p>'}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>batch_dict = self.backbone_2d(batch_dict)<br>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_2d/base_bev_backbone.py:BaseBEVBackbone:def forward</p>\n<p>spatial_features=torch.Size([2, 384, 256, 256])<br>\nlen(self.blocks)=2<br>\ni=0:<br>\n<code>spatial_features_1x</code>=torch.Size([2, 384, 256, 256])-&gt;torch.Size([2, 128, 256, 256])<br>\nself.deblocks<a href="x">i</a>-&gt;torch.Size([2, 256, 256, 256])<br>\ni=1:<br>\n<code>spatial_features_1x</code>=torch.Size([2, 128, 256, 256])-&gt;torch.Size([2, 256, 128, 128])<br>\nself.deblocks<a href="x">i</a>-&gt;torch.Size([2, 256, 256, 256])<br>\n<code>spatial_features_2d</code>x=torch.cat(ups, dim=1) -&gt;torch.Size([2, 512, 256, 256])<br></p>'}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>batch_dict = self.dense_head(batch_dict)<br>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/center_head.py:CenterHead:def forward</p>\n<p>spatial_features_2d-&gt;torch.Size([2, 512, 256, 256])<br>\nx-&gt;torch.Size([2, 64, 256, 256])<br>\nlen(self.heads_list)=1<br>\n<code>pred_dicts</code><br>\n[(key,value.shape) for key,value in pred_dicts[0].items()]<br>\n(\'center\', torch.Size([2, 2, 256, 256])),<br>\n(\'center_z\', torch.Size([2, 1, 256, 256])),<br>\n(\'dim\', torch.Size([2, 3, 256, 256])),<br>\n(\'rot\', torch.Size([2, 2, 256, 256])),<br>\n(\'hm\', torch.Size([2, 7, 256, 256]))]<br>\n<code>--------------if self.training---------------------</code><br>\ntarget_dict = self.assign_targets<br></p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/center_head.py:CenterHead:def assign_targets</p>\n<p>target_assigner_cfg-&gt;{\'FEATURE_MAP_STRIDE\': 8, \'NUM_MAX_OBJS\': 500, \'GAUSSIAN_OVERLAP\': 0.1, \'MIN_RADIUS\': 2}<br>\nall_names-&gt;array([\'bg\', \'Pedestrian\', \'Bicycle\', \'Car\', \'Truck\', \'Vehicle\', \'Motorcycle\', \'Bus\'], dtype=\'&lt;U10\')<br>\n<code>----for idx, cur_class_names in enumerate(self.class_names_each_head)---</code>对于每个类别<br>\n<code>-------------------for bs_idx in range(batch_size)----------------------</code>对于每个batch_id<br>\nheatmap, ret_boxes, inds, mask = self.assign_target_of_single_head<br></p>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/center_head.py:CenterHead:def assign_target_of_single_head</p>heatmap->torch.Size([7, 256, 256])<br>\nret_boxes->torch.Size([500, 8])<br>\ncenter_int是feature_map_size-(256, 256)这个范围内的值<br>\nret_boxes是0-1是中心点距离中心int后的距离，2是正常z的值，3-6是正常长宽高的log，6-7是角度的正余弦<br>\ninds是对于某个点x,y，y*w+x,mask该处有gtbox<br>'}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/center_head.py:CenterHead:def assign_targets</p>\n<p><code>target_dicts</code><br>\nheatmaps-torch.Size([2, 7, 256, 256])<br>\ntarget_boxes-torch.Size([2, 500, 8])<br>\ninds-torch.Size([2, 500])<br>\nmasks-torch.Size([2, 500])<br></p>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/center_head.py:CenterHead:def forward</p>\n<p><code>-------if not self.training or self.predict_boxes_when_training-------</code><br>\npred_dicts = self.generate_predicted_boxes<br></p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/center_head.py:CenterHead:def generate_predicted_boxes</p>pred_boxes<br>\npred_scores<br>\npred_labels<br>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/center_head.py:CenterHead:def forward</p>\n<p><code>---------------if self.predict_boxes_when_training--------------------</code><br>\nrois, roi_scores, roi_labels = self.reorder_rois_for_refining<br></p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/center_head.py:CenterHead:def reorder_rois_for_refining</p>\n<p><code>rois</code>:torch.Size([2, 164, 7])<br>\n<code>roi_scores</code>:torch.Size([2, 164])<br>\n<code>roi_labels</code>:torch.Size([2, 164])-预测label的范围有1-num_class<br>\n<code>has_class_labels</code>:True<br></p>'}]}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>\n<p>batch_dict = self.roi_head.proposal_layer里面没执行<br>\n<code>--------------if self.training:-----------------</code><br>\ntargets_dict = self.roi_head.assign_targets<br></p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:RoIHeadTemplate:def assign_targets</p>targets_dict = self.proposal_target_layer.forward(batch_dict)<br>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/target_assigner/proposal_target_layer.py:ProposalTargetLayer:def forward</p>batch_rois, batch_gt_of_rois, batch_roi_ious, batch_roi_scores, batch_roi_labels = self.sample_rois_for_rcnn<br>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/target_assigner/proposal_target_layer.py:ProposalTargetLayer:def sample_rois_for_rcnn</p>\n<p>根据rois和gt的iou给这些rois定义成正负样本<br>\nbatch_size-2<br>\nrois-torch.Size([2, 36, 7])<br>\nroi_scores-torch.Size([2, 36])<br>\nroi_labels-torch.Size([2, 36])<br>\ngt_boxes-torch.Size([2, 68, 8])<br>\nbatch_rois-torch.Size([2, 128, 7])【self.roi_sampler_cfg.ROI_PER_IMAGE=128】-》用来控制正负样本数量 预测的128个roi<br>\nbatch_gt_of_rois=torch.Size([2, 128, 8])-》预测的128个roi与匹配到的对应gt<br>\nbatch_roi_ious=torch.Size([2, 128])-》预测的128个roi与匹配到的gt的最大iou<br>\nbatch_roi_scores=torch.Size([2, 128])<br>\nbatch_roi_labels=torch.Size([2, 128])-》预测的128个roi的label<br>\n<code>-------------------if self.roi_sampler_cfg.get(\'SAMPLE_ROI_BY_EACH_CLASS\', False)--------------------------</code><br>\nmax_overlaps, gt_assignment = self.get_max_iou_with_same_class<br></p>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/target_assigner/proposal_target_layer.py:ProposalTargetLayer:def get_max_iou_with_same_class</p>max_overlaps, gt_assignment    # 里面存的是iou，以及对应的gt box；<br>'}]}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/target_assigner/proposal_target_layer.py:ProposalTargetLayer:def sample_rois_for_rcnn</p>sampled_inds = self.subsample_rois(max_overlaps=max_overlaps)<br>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/target_assigner/proposal_target_layer.py:ProposalTargetLayer:def subsample_rois</p>'}]}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/target_assigner/proposal_target_layer.py:ProposalTargetLayer:def forward</p>reg_valid_mask->torch.Size([2, 128])最开始里面的值都为0，因为都不会匹配上<br>\niou_bg_thresh=0.25; iou_fg_thresh=0.75<br>\ninterval_mask-torch.Size([2, 128])0.25-0.75之间的数据<br>\nbatch_cls_labels,分类的权重相当于，在iou>0.75以上是1，iou是0.5则:label=(0.5-0.25)/(0.75-0.25)<br>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:RoIHeadTemplate:def assign_targets</p>\n<p>rois-torch.Size([2, 128, 7]第一阶段的rois，<br>\nroi_labels-torch.Size([2, 128, 7]),用来控制正负样本数量 预测的128个roi<br>\n<code>gt_of_rois_src</code>:gt_of_rois,torch.Size([2, 128, 8])与预测的rois匹配的gt box<br>\ngt_of_rois-&gt;torch.Size([2, 128, 8])，x,y,z是gt与pr的中心差，l,w,h是gt的值，ry是gt与pr的差<br></p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/utils/common_utils.py:rotate_points_along_z</p>points-torch.Size([256, 1, 8])<br>\nangle-torch.Size([256])<br>\n将中心点根据角度旋转了<br>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:RoIHeadTemplate:def assign_targets</p>\n<p>又将orientation处理？？？？？？？？？？？？？？？？？？？<br>\n<code>gt_of_rois</code>-torch.Size([2, 128, 8])<br></p>'}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>\n<p><code>rois</code>:<br>\n<code>roi_labels</code>:<br>\n<code>roi_targets_dict</code>:<br>\nnum_rois_per_scene=128<br>\nbatch_dict = self.pfe(batch_dict)<br></p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def forward</p>keypoints = self.get_sampled_points(batch_dict)<br>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def get_sampled_points</p>\n<p><code>---------------if self.model_cfg.POINT_SOURCE == \'raw_points\'-------------------</code><br>\nsrc_points-torch.Size([208668, 3]); batch_indices-torch.Size([208668])<br>\n<code>---------------------for bs_idx in range(batch_size)---------------------------</code><br>\n<code>-----------------elif self.model_cfg.SAMPLE_METHOD == \'SPC\'--------------------</code><br>\ncur_keypoints = self.sectorized_proposal_centric_sampling<br></p>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def sectorized_proposal_centric_sampling</p>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def sample_points_with_roi</p>'}, {'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def sector_fps</p>'}]}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def get_sampled_points</p>keypoints->torch.Size([4098, 4])->torch.Size([8198, 4])第一维表示属于哪个batch<br>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def forward</p>\n<p>self.model_cfg.FEATURES_SOURCE=[\'bev\', \'x_conv3\', \'x_conv4\', \'raw_points\']<br>\n<code>------------if \'bev\' in self.model_cfg.FEATURES_SOURCE:------------------</code><br>\npoint_bev_features = self.interpolate_from_bev_features<br></p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:interpolate_from_bev_features</p>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def forward</p>\n<p>point_bev_features-&gt;torch.Size([8198, 384])<br>\n<code>-------------if \'raw_points\' in self.model_cfg.FEATURES_SOURCE-----------</code><br>\npooled_features = self.aggregate_keypoint_features_from_one_source<br></p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def aggregate_keypoint_features_from_one_source</p>\n<p>aggregate_func:VectorPoolAggregationModuleMSG<br>\nxyz: (N, 3)-torch.Size([225443, 3])原始所有点云<br>\nxyz_features: (N, C)       torch.Size([225443, 1])<br>\nxyz_bs_idxs: (N)           torch.Size([225443])<br>\nnew_xyz: (M, 3)            torch.Size([8198, 3])根据rois采集到的关键点<br>\nnew_xyz_batch_cnt:         tensor([4100, 4098],<br>\nfilter_neighbors_with_roi: True<br>\nradius_of_neighbor:        2.4<br>\nnum_max_points_of_part:    200000<br>\nrois:                      torch.Size([2, 128, 7])<br>\n<code>---------------------if filter_neighbors_with_roi--------------------------</code><br>\npoint_features-torch.Size([225443, 4])<br>\n<code>------------------for bs_idx in range(batch_size)-----------------------------</code><br>\n_, valid_mask = sample_points_with_roi<br></p>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:def sample_points_with_roi</p>\n<p><code>----------------------if points.shape[0] &lt; num_max_points_of_part-------------</code><br>\ndistance-torch.Size([108004, 128])<br>\nmin_dis, min_dis_roi_idx:torch.Size([108004])与128个rois的最小距离以及对应的rois<br>\n保留距离对角线距离+2.4范围内的点共采集92869个点<br>\nsampled_points-&gt;torch.Size([92869, 3]), point_mas-&gt;torch.Size([108004])<br></p>'}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def aggregate_keypoint_features_from_one_source</p>valid_point_features->torch.Size([201047, 4])<br>\npooled_points, pooled_features = aggregate_func<br>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/ops/pointnet2/pointnet2_stack/pointnet2_modules.py:VectorPoolAggregationModuleMSG:def forward</p>self.num_groups=2<br>\nfeatures_list=[torch.Size([8198, 32]),torch.Size([8198, 32])]<br>\nfeatures-torch.Size([8198, 64])-torch.Size([8198, 67])-torch.Size([1, 67, 8198])<br>\nnew_features-torch.Size([1, 32, 8198])- torch.Size([8198, 32])<br>'}]}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def forward</p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def aggregate_keypoint_features_from_one_source</p>pooled_features->torch.Size([8198, 32])<br>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/backbones_3d/pfe/voxel_set_abstraction.py:VoxelSetAbstraction:def forward</p>\n<p><code>-----------------for k, src_name in enumerate(self.SA_layer_names):-------</code><br>\nself.SA_layer_names=[\'x_conv3\', \'x_conv4\']<br>\ncur_coords-torch.Size([116179, 4])相当于是那个特征图上的坐标(0-N)<br>\ncur_features-torch.Size([116179, 64])<br>\nxyz = common_utils.get_voxel_centers:就是将0-n的范围回归到(-51.2,51.2)<br>\npooled_features = self.aggregate_keypoint_features_from_one_source跟上面函数差不多<br>\npoint_features_list-&gt;<br>\ntorch.Size([8198, 128]),torch.Size([8198, 128])<br>\n<code>point_features_before_fusion</code>point_features-torch.Size([8198, 672])<br>\n<code>point_features</code>point_features-&gt;torch.Size([8198, 90])<br>\n<code>point_coords</code>-&gt;torch.Size([8198, 4])<br></p>'}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>batch_dict = self.point_head(batch_dict)<br>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/point_head_simple.py:class PointHeadSimple:def forward</p>\n<p><code>if self.model_cfg.get(\'USE_POINT_FEATURES_BEFORE_FUSION\', False)</code><br>\npoint_features-torch.Size([8198, 672])<br>\n<code>point_cls_preds</code>:torch.Size([8198, 1]); <code>point_cls_scores</code>:torch.Size([8198])<br>\n<code>---------------------if self.training:-----------------------------</code><br>\ntargets_dict = self.assign_targets(batch_dict)<br></p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/point_head_simple.py:class PointHeadSimple:def assign_targets</p>point_coords-torch.Size([8198, 4])关键点的坐标<br>\ngt_boxes->torch.Size([2, 101, 8])-gtbox<br>\nextend_gt_boxes将gtbox扩大，x,y,z扩大(0.2, 0.2, 0.2）<br>\ntargets_dict = self.assign_stack_targets<br>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/point_head_template.py:class PointHeadTemplate:def assign_stack_targets</p>\n<p>point_cls_labels:torch.Size([8198])<br>\npoint_box_labels-None; point_part_labels-None<br>\n<code>-----------------------for k in range(batch_size)--------------------------------</code><br>\n对于某个batch_id<br>\npoints_single-torch.Size([4099, 3])<br>\n判断点是不是在box里面则天对应的label，否则为0，-1为ignore<br></p>'}]}]}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>batch_dict = self.roi_head(batch_dict)<br>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:class PVRCNNHead:def forward</p>\n<p>targets_dict = self.proposal_layer没有做任何事<br>\n<code>-----------------------if self.training--------------------------</code><br>\ntargets_dict有值<br>\npooled_features = self.roi_grid_pool(batch_dict)<br></p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:class PVRCNNHead:def roi_grid_pool</p>batch_size-2<br>\nrois-torch.Size([2, 128, 7])<br>\npoint_coords-torch.Size([8198, 4])<br>\npoint_features-torch.Size([8198, 90])<br>\ngrid_size=self.model_cfg.ROI_GRID_POOL.GRID_SIZE=6<br>\nglobal_roi_grid_points, local_roi_grid_points = self.get_global_grid_points_of_roi<br>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:class PVRCNNHead:def get_global_grid_points_of_roi</p>rois-torch.Size([256, 7])； batch_size_rcnn-256； grid_size-6<br>\nlocal_roi_grid_points = self.get_dense_grid_points<br>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:class PVRCNNHead:def get_dense_grid_points</p>faked_features-torch.Size([6, 6, 6])<br>\ndense_idx-torch.Size([216, 3])值为0，6x6x6=216,非0函数索引<br>\ndense_idx-torch.Size([256, 216, 3])<br>\nlocal_roi_size-torch.Size([256, 7])->torch.Size([256, 3])长宽高<br>\nroi_grid_points-》torch.Size([256, 216, 3])：？？？？？？？？？？？？？？？？？什么操作<br>'}]}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:class PVRCNNHead:def get_global_grid_points_of_roi</p>global_roi_grid_points = common_utils.rotate_points_along_z????????<br>'}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:class PVRCNNHead:def roi_grid_pool</p>global_roi_grid_points->torch.Size([256, 216, 3])->torch.Size([2, 27648, 3])<br>\nxyz->torch.Size([8199, 3])<br>\nnew_xyz->torch.Size([55296, 3])<br>\nxyz_batch_cnt<br>\nnew_xyz_batch_cnt->tensor([27648, 27648], device=\'cuda:0\', dtype=torch.int32)<br>\npooled_points, pooled_features = self.roi_grid_pool_layer-->VectorPoolAggregationModuleMSG<br>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/ops/pointnet2/pointnet2_stack/pointnet2_modules.py:VectorPoolAggregationModuleMSG:def forward</p>features_list-[torch.Size([55296, 64])，torch.Size([55296, 64])]<br>\nfeatures-torch.Size([55296, 128])-torch.Size([55296, 131])-torch.Size([1, 131, 55296])<br>\nnew_features-torch.Size([1, 128, 55296])-torch.Size([55296, 128])<br>'}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:class PVRCNNHead:def roi_grid_pool</p>pooled_features-torch.Size([256, 216, 128]),256为两个rois的和，216=6x6x6<br>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/pvrcnn_head.py:class PVRCNNHead:def forward</p>\n<p>pooled_features-torch.Size([256, 216, 128])-torch.Size([256, 128, 6, 6, 6])<br>\nshared_features-torch.Size([256, 256, 1])<br>\n<code>rcnn_cls</code>rcnn_cls-torch.Size([256, 1])用来算置信度<br>\n<code>rcnn_reg</code>rcnn_reg-torch.Size([256, 7])<br></p>'}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def forward</p>\n<p><code>----------------------if self.training-----------------------------</code><br>\nloss, tb_dict, disp_dict = self.get_training_loss()<br></p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def get_training_loss</p>loss_rpn, tb_dict = self.dense_head.get_loss()       # CenterHead<br>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/center_head.py:class CenterHead:def get_loss</p>pred_dicts-<br>\n(\'center\', torch.Size([2, 2, 256, 256])),<br>\n(\'center_z\', torch.Size([2, 1, 256, 256])),<br>\n(\'dim\', torch.Size([2, 3, 256, 256])),<br>\n(\'rot\', torch.Size([2, 2, 256, 256])),<br>\n(\'hm\', torch.Size([2, 7, 256, 256]))<br>\ntarget_dicts-heatmaps:torch.Size([2, 7, 256, 256]),target_boxes:(2,500,8),inds:(2,500),masks:(2,500)<br>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def get_training_loss</p>loss_point, tb_dict = self.point_head.get_loss(tb_dict)       # PointHeadSimple<br>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/point_head_simple.py:PointHeadSimple:def get_loss</p>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/dense_heads/point_head_template.py:PointHeadTemplate:def get_cls_layer_loss</p>'}]}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/detectors/pv_rcnn_plusplus.py:PVRCNNPlusPlus:def get_training_loss</p>loss_rcnn, tb_dict = self.roi_head.get_loss(tb_dict)<br>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/roi_head_template.py:RoIHeadTemplate:def get_loss</p>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/roi_head_template.py:RoIHeadTemplate:def get_box_cls_layer_loss</p>'}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">pcdet/models/roi_heads/roi_head_template.py:RoIHeadTemplate:def get_box_reg_layer_loss</p>'}]}]}]}]})</script></body>
</html>
