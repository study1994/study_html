<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>ObjectSample流程</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/prism.css"><link rel="stylesheet" href="https://study1994.github.io/study_html/npm/markmap-toolbar@0.13.5/dist/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/d3@6.7.0"></script>
    <script src="https://study1994.github.io/study_html/npm/markmap-view@0.13.5"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">初始化</p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/transforms_3d.py</p><font size="0"><pre class="language-python"><code class="language-python">class ObjectSample(object):\n    def __init__(self, db_sampler, sample_2d=False, stop_epoch=None):\n        self.sampler_cfg = db_sampler\n        self.sample_2d = sample_2d\n        if \'type\' not in db_sampler.keys():\n            db_sampler[\'type\'] = \'DataBaseSampler\'\n        self.db_sampler = <span style=\'color: green;font-weight: bold;\'>build_from_cfg</span>(db_sampler, OBJECTSAMPLERS)  <span style=\'color: red\'># mmdet3d/datasets/pipelines/dbsampler.py</span>\n        self.epoch = -1\n        self.stop_epoch = stop_epoch\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><font size="0"><pre class="language-python"><code class="language-python">class DataBaseSampler(object):\n    def __init__(...):\n        super().__init__()\n        self.data_root = data_root       <span style=\'color: red\'># \'data/minieye_3D/\'</span>\n        self.info_path = info_path       <span style=\'color: red\'># \'data/minieye_3D/train_all/minieye_dbinfos_train.pkl\'</span>\n        self.rate = rate\n        self.prepare = prepare\n        self.classes = classes           <span style=\'color: red\'># [\'Vehicle\', \'Pedestrian\', \'Bicycle\', \'Rider\', \'Barrier\']</span>\n        self.cat2label = {name: i for i, name in enumerate(classes)}\n        self.label2cat = {i: name for i, name in enumerate(classes)}\n        self.points_loader = mmcv.build_from_cfg(points_loader, PIPELINES)\n        db_infos = mmcv.load(info_path)\n        <span style=\'color: red\'># filter database infos</span>\n        for k, v in db_infos.items():\n            print(f\'load {len(v)} {k} database infos\')\n        for prep_func, val in prepare.items():\n            db_infos = getattr(self, prep_func)(db_infos, val)\n        print(\'After filter database:\')\n        for k, v in db_infos.items():\n            print(f\'load {len(v)} {k} database infos\')\n        self.db_infos = db_infos\n        <span style=\'color: red\'># load sample groups</span>\n        <span style=\'color: red\'># TODO: more elegant way to load sample groups</span>\n        self.sample_groups = []\n        for name, num in sample_groups.items():\n            self.sample_groups.append({name: int(num)})        <span style=\'color: red\'># [{\'Vehicle\': 6}, {\'Pedestrian\': 6}, {\'Bicycle\': 5}, {\'Rider\': 8}, {\'Barrier\': 8}]</span>\n        self.group_db_infos = self.db_infos  <span style=\'color: red\'># just use db_infos</span>\n        self.sample_classes = []\n        self.sample_max_nums = []\n        for group_info in self.sample_groups:\n            self.sample_classes += list(group_info.keys())     <span style=\'color: red\'># [\'Vehicle\', \'Pedestrian\', \'Bicycle\', \'Rider\', \'Barrier\']</span>\n            self.sample_max_nums += list(group_info.values())  <span style=\'color: red\'># [6, 6, 5, 8, 8]</span>\n        self.sampler_dict = {}\n        for k, v in self.group_db_infos.items():\n            self.sampler_dict[k] = <span style=\'color: green;font-weight: bold;\'>BatchSampler</span>(v, k, shuffle=True)\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><font size="0"><pre class="language-python"><code class="language-python">class BatchSampler:\n    def __init__(......):\n        self._sampled_list = sampled_list      <span style=\'color: red\'># sampled_list[0]={\'name\': \'Vehicle\', \'path\': \'...icle_0.bin\', \'image_idx\': \'002000053_pandar128\', \'gt_idx\': 0, \'box3d_lidar\':, \'num_points_in_gt\': 730...}</span>\n        self._indices = np.arange(len(sampled_list))\n        if shuffle:                            <span style=\'color: red\'># True</span>\n            np.random.shuffle(self._indices)\n        self._idx = 0\n        self._example_num = len(sampled_list)  <span style=\'color: red\'># 600987</span>\n        self._name = name                      <span style=\'color: red\'># \'Vehicle\'</span>\n        self._shuffle = shuffle\n        self._epoch = epoch                    <span style=\'color: red\'># None</span>\n        self._epoch_counter = 0\n        self._drop_reminder = drop_reminder   <span style=\'color: red\'># False</span>\n</code></pre></font>'}]}]}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">采样</p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/transforms_3d.py</p><font size="0"><pre class="language-python"><code class="language-python">class ObjectSample(object):\n    def __call__(self, input_dict):\n        if self.stop_epoch is not None and self.epoch >= self.stop_epoch:\n            return input_dict\n        gt_bboxes_3d = input_dict[\'gt_bboxes_3d\']\n        gt_labels_3d = input_dict[\'gt_labels_3d\']\n        <span style=\'color: red\'># change to float for blending operation</span>\n        points = input_dict[\'points\']\n        if self.sample_2d:              <span style=\'color: red\'># False</span>\n            ........\n        else:\n            sampled_dict = self.db_sampler.<span style=\'color: green;font-weight: bold;\'>sample_all</span>(gt_bboxes_3d.tensor.numpy(), gt_labels_3d, img=None)\n        if sampled_dict is not None:\n            sampled_gt_bboxes_3d = sampled_dict[\'gt_bboxes_3d\']\n            sampled_points = sampled_dict[\'points\']\n            sampled_gt_labels = sampled_dict[\'gt_labels_3d\']\n            gt_labels_3d = np.concatenate([gt_labels_3d, sampled_gt_labels],axis=0)\n            gt_bboxes_3d = gt_bboxes_3d.new_box(np.concatenate(\n                    [gt_bboxes_3d.tensor.numpy(), sampled_gt_bboxes_3d]))\n            points = self.remove_points_in_boxes(points, sampled_gt_bboxes_3d)\n            <span style=\'color: red\'># check the points dimension</span>\n            points = points.cat([sampled_points, points])\n            if self.sample_2d:\n                sampled_gt_bboxes_2d = sampled_dict[\'gt_bboxes_2d\']\n                gt_bboxes_2d = np.concatenate([gt_bboxes_2d, sampled_gt_bboxes_2d]).astype(np.float32)\n                input_dict[\'gt_bboxes\'] = gt_bboxes_2d\n                input_dict[\'img\'] = sampled_dict[\'img\']\n        input_dict[\'gt_bboxes_3d\'] = gt_bboxes_3d\n        input_dict[\'gt_labels_3d\'] = gt_labels_3d.astype(np.long)\n        input_dict[\'points\'] = points\n        return input_dict\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><font size="0"><pre class="language-python"><code class="language-python">class DataBaseSampler(object):\n    def sample_all(self, gt_bboxes, gt_labels, img=None):\n        sampled_num_dict = {}\n        sample_num_per_class = []\n        for class_name, max_sample_num in zip(self.sample_classes,self.sample_max_nums):        <span style=\'color: red\'># \'Vehicle\',6</span>\n            class_label = self.cat2label[class_name]                                            <span style=\'color: red\'># 0</span>\n            <span style=\'color: red\'># sampled_num = int(max_sample_num -np.sum([n == class_name for n in gt_names]))</span>\n            sampled_num = int(max_sample_num - np.sum([n == class_label for n in gt_labels]))   <span style=\'color: red\'># -24 原先30輛車不采樣</span>\n            sampled_num = np.round(self.rate * sampled_num).astype(np.int64)                    <span style=\'color: red\'># -24</span>\n            sampled_num_dict[class_name] = sampled_num\n            sample_num_per_class.append(sampled_num)\n        sampled = []\n        sampled_gt_bboxes = []\n        avoid_coll_boxes = gt_bboxes\n        for class_name, sampled_num in zip(self.sample_classes,sample_num_per_class):           <span style=\'color: red\'># \'Pedestrian\'  ,4</span>\n            if sampled_num > 0:\n                sampled_cls = self.<span style=\'color: green;font-weight: bold;\'>sample_class_v2</span>(class_name, sampled_num, avoid_coll_boxes)   <span style=\'color: red\'># [{\'name\': \'Pedestrian\', \'path\': \'minieye_gt_database/...ian_92.bin\', \'i,.....]</span>\n                sampled += sampled_cls\n                if len(sampled_cls) > 0:\n                    if len(sampled_cls) == 1:\n                        sampled_gt_box = sampled_cls[0][\'box3d_lidar\'][np.newaxis, ...]\n                    else:\n                        sampled_gt_box = np.stack([s[\'box3d_lidar\'] for s in sampled_cls], axis=0)\n                    sampled_gt_bboxes += [sampled_gt_box]\n                    avoid_coll_boxes = np.concatenate([avoid_coll_boxes, sampled_gt_box], axis=0)\n        ret = None\n        if len(sampled) > 0:\n            sampled_gt_bboxes = np.concatenate(sampled_gt_bboxes, axis=0)\n            <span style=\'color: red\'># center = sampled_gt_bboxes[:, 0:3]</span>\n            <span style=\'color: red\'># num_sampled = len(sampled)</span>\n            s_points_list = []\n            count = 0\n            for info in sampled:        <span style=\'color: red\'># [{\'name\': \'Pedestrian\', \'path\': \'minieye_gt_database,...]</span>\n                file_path = os.path.join(self.data_root,info[\'path\']) if self.data_root else info[\'path\']\n                results = dict(pts_filename=file_path)            <span style=\'color: red\'># {\'pts_filename\': \'data/minieye_3D/mini...ian_92.bin\'}</span>\n                s_points = self.points_loader(results)[\'points\']\n                s_points.translate(info[\'box3d_lidar\'][:3])\n                count += 1\n                s_points_list.append(s_points)\n            gt_labels = np.array([self.cat2label[s[\'name\']] for s in sampled],dtype=np.long)\n            ret = {\'gt_labels_3d\':gt_labels,\'gt_bboxes_3d\':sampled_gt_bboxes,\'points\':s_points_list[0].cat(s_points_list),\n                \'group_ids\':np.arange(gt_bboxes.shape[0],gt_bboxes.shape[0] + len(sampled))}\n        return ret\n</code></pre></font>'}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><font size="0"><pre class="language-python"><code class="language-python">class DataBaseSampler(object):\n    def sample_class_v2(self, name, num, gt_bboxes):\n        sampled = self.sampler_dict[name].<span style=\'color: green;font-weight: bold;\'>sample</span>(num)      <span style=\'color: red\'># \'people:4 -> [{\'name\': \'Pedestrian\', \'path\': \'minieye_gt_database/...ian_92.bin\', \'i,...,]</span>\n        sampled = copy.deepcopy(sampled)\n        num_gt = gt_bboxes.shape[0]\n        num_sampled = len(sampled)\n        gt_bboxes_bv = box_np_ops.center_to_corner_box2d(gt_bboxes[:, 0:2], gt_bboxes[:, 3:5], gt_bboxes[:, 6])\n        sp_boxes = np.stack([i[\'box3d_lidar\'] for i in sampled], axis=0)\n        boxes = np.concatenate([gt_bboxes, sp_boxes], axis=0).copy()\n        sp_boxes_new = boxes[gt_bboxes.shape[0]:]\n        sp_boxes_bv = box_np_ops.center_to_corner_box2d(sp_boxes_new[:, 0:2], sp_boxes_new[:, 3:5], sp_boxes_new[:, 6])\n        total_bv = np.concatenate([gt_bboxes_bv, sp_boxes_bv], axis=0)\n        coll_mat = data_augment_utils.box_collision_test(total_bv, total_bv)\n        diag = np.arange(total_bv.shape[0])\n        coll_mat[diag, diag] = False\n        valid_samples = []\n        for i in range(num_gt, num_gt + num_sampled):\n            if coll_mat[i].any():\n                coll_mat[i] = False\n                coll_mat[:, i] = False\n            else:\n                valid_samples.append(sampled[i - num_gt])\n        return valid_samples                  <span style=\'color: red\'># [{\'name\': \'Pedestrian\', \'path\': \'minieye_gt_database/.,.....]</span>\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><font size="0"><pre class="language-python"><code class="language-python">class BatchSampler:\n    def _sample(self, num):\n        if self._idx + num >= self._example_num:\n            ret = self._indices[self._idx:].copy()\n            self._reset()\n        else:\n            ret = self._indices[self._idx:self._idx + num]        <span style=\'color: red\'># array([45564, 65496, 31532, 40615])</span>\n            self._idx += num                                      <span style=\'color: red\'># 4</span>\n        return ret\n    def _reset(self):\n        assert self._name is not None\n        if self._shuffle:\n            np.random.shuffle(self._indices)\n        self._idx = 0\n    def sample(self, num):\n        indices = self._sample(num)              <span style=\'color: red\'># 4采样4个</span>\n        return [self._sampled_list[i] for i in indices]\n</code></pre></font>'}]}]}]}]})</script></body>
</html>
