<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>ObjectSample流程</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
.hidden-code {
  display: none !important;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/mycss/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/myjs/d3@6.7.0.js"></script>
    <script src="https://study1994.github.io/study_html/npm/myjs/markmap-view@0.13.5.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">初始化</p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/transforms_3d.py</p><span class=\'hidden-code\' data-code=\'class ObjectSample(object):\n    def __init__(self, db_sampler, sample_2d=False, stop_epoch=None):\n        self.sampler_cfg = db_sampler\n        self.sample_2d = sample_2d\n        if &amp;#39;type&amp;#39; not in db_sampler.keys():\n            db_sampler[&amp;#39;type&amp;#39;] = &amp;#39;DataBaseSampler&amp;#39;\n        self.db_sampler = `build_from_cfg`(db_sampler, OBJECTSAMPLERS)  # mmdet3d/datasets/pipelines/dbsampler.py\n        self.epoch = -1\n        self.stop_epoch = stop_epoch\n\'> </span>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><span class=\'hidden-code\' data-code=\'class DataBaseSampler(object):\n    def __init__(...):\n        super().__init__()\n        self.data_root = data_root       # &amp;#39;data/minieye_3D/&amp;#39;\n        self.info_path = info_path       # &amp;#39;data/minieye_3D/train_all/minieye_dbinfos_train.pkl&amp;#39;\n        self.rate = rate\n        self.prepare = prepare\n        self.classes = classes           # [&amp;#39;Vehicle&amp;#39;, &amp;#39;Pedestrian&amp;#39;, &amp;#39;Bicycle&amp;#39;, &amp;#39;Rider&amp;#39;, &amp;#39;Barrier&amp;#39;]\n        self.cat2label = {name: i for i, name in enumerate(classes)}\n        self.label2cat = {i: name for i, name in enumerate(classes)}\n        self.points_loader = mmcv.build_from_cfg(points_loader, PIPELINES)\n        db_infos = mmcv.load(info_path)\n        # filter database infos\n        for k, v in db_infos.items():\n            print(f&amp;#39;load {len(v)} {k} database infos&amp;#39;)\n        for prep_func, val in prepare.items():\n            db_infos = getattr(self, prep_func)(db_infos, val)\n        print(&amp;#39;After filter database:&amp;#39;)\n        for k, v in db_infos.items():\n            print(f&amp;#39;load {len(v)} {k} database infos&amp;#39;)\n        self.db_infos = db_infos\n        # load sample groups\n        # TODO: more elegant way to load sample groups\n        self.sample_groups = []\n        for name, num in sample_groups.items():\n            self.sample_groups.append({name: int(num)})        # [{&amp;#39;Vehicle&amp;#39;: 6}, {&amp;#39;Pedestrian&amp;#39;: 6}, {&amp;#39;Bicycle&amp;#39;: 5}, {&amp;#39;Rider&amp;#39;: 8}, {&amp;#39;Barrier&amp;#39;: 8}]\n        self.group_db_infos = self.db_infos  # just use db_infos\n        self.sample_classes = []\n        self.sample_max_nums = []\n        for group_info in self.sample_groups:\n            self.sample_classes += list(group_info.keys())     # [&amp;#39;Vehicle&amp;#39;, &amp;#39;Pedestrian&amp;#39;, &amp;#39;Bicycle&amp;#39;, &amp;#39;Rider&amp;#39;, &amp;#39;Barrier&amp;#39;]\n            self.sample_max_nums += list(group_info.values())  # [6, 6, 5, 8, 8]\n        self.sampler_dict = {}\n        for k, v in self.group_db_infos.items():\n            self.sampler_dict[k] = `BatchSampler`(v, k, shuffle=True)\n\'> </span>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><span class=\'hidden-code\' data-code=\'class BatchSampler:\n    def __init__(......):\n        self._sampled_list = sampled_list      # sampled_list[0]={&amp;#39;name&amp;#39;: &amp;#39;Vehicle&amp;#39;, &amp;#39;path&amp;#39;: &amp;#39;...icle_0.bin&amp;#39;, &amp;#39;image_idx&amp;#39;: &amp;#39;002000053_pandar128&amp;#39;, &amp;#39;gt_idx&amp;#39;: 0, &amp;#39;box3d_lidar&amp;#39;:, &amp;#39;num_points_in_gt&amp;#39;: 730...}\n        self._indices = np.arange(len(sampled_list))\n        if shuffle:                            # True\n            np.random.shuffle(self._indices)\n        self._idx = 0\n        self._example_num = len(sampled_list)  # 600987\n        self._name = name                      # &amp;#39;Vehicle&amp;#39;\n        self._shuffle = shuffle\n        self._epoch = epoch                    # None\n        self._epoch_counter = 0\n        self._drop_reminder = drop_reminder   # False\n\'> </span>'}]}]}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">采样</p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/transforms_3d.py</p><span class=\'hidden-code\' data-code=\'class ObjectSample(object):\n    def __call__(self, input_dict):\n        if self.stop_epoch is not None and self.epoch >= self.stop_epoch:\n            return input_dict\n        gt_bboxes_3d = input_dict[&amp;#39;gt_bboxes_3d&amp;#39;]\n        gt_labels_3d = input_dict[&amp;#39;gt_labels_3d&amp;#39;]\n        # change to float for blending operation\n        points = input_dict[&amp;#39;points&amp;#39;]\n        if self.sample_2d:              # False\n            ........\n        else:\n            sampled_dict = self.db_sampler.`sample_all`(gt_bboxes_3d.tensor.numpy(), gt_labels_3d, img=None)\n        if sampled_dict is not None:\n            sampled_gt_bboxes_3d = sampled_dict[&amp;#39;gt_bboxes_3d&amp;#39;]\n            sampled_points = sampled_dict[&amp;#39;points&amp;#39;]\n            sampled_gt_labels = sampled_dict[&amp;#39;gt_labels_3d&amp;#39;]\n            gt_labels_3d = np.concatenate([gt_labels_3d, sampled_gt_labels],axis=0)\n            gt_bboxes_3d = gt_bboxes_3d.new_box(np.concatenate(\n                    [gt_bboxes_3d.tensor.numpy(), sampled_gt_bboxes_3d]))\n            points = self.remove_points_in_boxes(points, sampled_gt_bboxes_3d)\n            # check the points dimension\n            points = points.cat([sampled_points, points])\n            if self.sample_2d:\n                sampled_gt_bboxes_2d = sampled_dict[&amp;#39;gt_bboxes_2d&amp;#39;]\n                gt_bboxes_2d = np.concatenate([gt_bboxes_2d, sampled_gt_bboxes_2d]).astype(np.float32)\n                input_dict[&amp;#39;gt_bboxes&amp;#39;] = gt_bboxes_2d\n                input_dict[&amp;#39;img&amp;#39;] = sampled_dict[&amp;#39;img&amp;#39;]\n        input_dict[&amp;#39;gt_bboxes_3d&amp;#39;] = gt_bboxes_3d\n        input_dict[&amp;#39;gt_labels_3d&amp;#39;] = gt_labels_3d.astype(np.long)\n        input_dict[&amp;#39;points&amp;#39;] = points\n        return input_dict\n\'> </span>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><span class=\'hidden-code\' data-code=\'class DataBaseSampler(object):\n    def sample_all(self, gt_bboxes, gt_labels, img=None):\n        sampled_num_dict = {}\n        sample_num_per_class = []\n        for class_name, max_sample_num in zip(self.sample_classes,self.sample_max_nums):        # &amp;#39;Vehicle&amp;#39;,6\n            class_label = self.cat2label[class_name]                                            # 0\n            # sampled_num = int(max_sample_num -np.sum([n == class_name for n in gt_names]))\n            sampled_num = int(max_sample_num - np.sum([n == class_label for n in gt_labels]))   # -24 原先30輛車不采樣\n            sampled_num = np.round(self.rate * sampled_num).astype(np.int64)                    # -24\n            sampled_num_dict[class_name] = sampled_num\n            sample_num_per_class.append(sampled_num)\n        sampled = []\n        sampled_gt_bboxes = []\n        avoid_coll_boxes = gt_bboxes\n        for class_name, sampled_num in zip(self.sample_classes,sample_num_per_class):           # &amp;#39;Pedestrian&amp;#39;  ,4\n            if sampled_num > 0:\n                sampled_cls = self.`sample_class_v2`(class_name, sampled_num, avoid_coll_boxes)   # [{&amp;#39;name&amp;#39;: &amp;#39;Pedestrian&amp;#39;, &amp;#39;path&amp;#39;: &amp;#39;minieye_gt_database/...ian_92.bin&amp;#39;, &amp;#39;i,.....]\n                sampled += sampled_cls\n                if len(sampled_cls) > 0:\n                    if len(sampled_cls) == 1:\n                        sampled_gt_box = sampled_cls[0][&amp;#39;box3d_lidar&amp;#39;][np.newaxis, ...]\n                    else:\n                        sampled_gt_box = np.stack([s[&amp;#39;box3d_lidar&amp;#39;] for s in sampled_cls], axis=0)\n                    sampled_gt_bboxes += [sampled_gt_box]\n                    avoid_coll_boxes = np.concatenate([avoid_coll_boxes, sampled_gt_box], axis=0)\n        ret = None\n        if len(sampled) > 0:\n            sampled_gt_bboxes = np.concatenate(sampled_gt_bboxes, axis=0)\n            # center = sampled_gt_bboxes[:, 0:3]\n            # num_sampled = len(sampled)\n            s_points_list = []\n            count = 0\n            for info in sampled:        # [{&amp;#39;name&amp;#39;: &amp;#39;Pedestrian&amp;#39;, &amp;#39;path&amp;#39;: &amp;#39;minieye_gt_database,...]\n                file_path = os.path.join(self.data_root,info[&amp;#39;path&amp;#39;]) if self.data_root else info[&amp;#39;path&amp;#39;]\n                results = dict(pts_filename=file_path)            # {&amp;#39;pts_filename&amp;#39;: &amp;#39;data/minieye_3D/mini...ian_92.bin&amp;#39;}\n                s_points = self.points_loader(results)[&amp;#39;points&amp;#39;]\n                s_points.translate(info[&amp;#39;box3d_lidar&amp;#39;][:3])\n                count += 1\n                s_points_list.append(s_points)\n            gt_labels = np.array([self.cat2label[s[&amp;#39;name&amp;#39;]] for s in sampled],dtype=np.long)\n            ret = {&amp;#39;gt_labels_3d&amp;#39;:gt_labels,&amp;#39;gt_bboxes_3d&amp;#39;:sampled_gt_bboxes,&amp;#39;points&amp;#39;:s_points_list[0].cat(s_points_list),\n                &amp;#39;group_ids&amp;#39;:np.arange(gt_bboxes.shape[0],gt_bboxes.shape[0] + len(sampled))}\n        return ret\n\'> </span>'}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><span class=\'hidden-code\' data-code=\'class DataBaseSampler(object):\n    def sample_class_v2(self, name, num, gt_bboxes):\n        sampled = self.sampler_dict[name].`sample`(num)      # &amp;#39;people:4 -> [{&amp;#39;name&amp;#39;: &amp;#39;Pedestrian&amp;#39;, &amp;#39;path&amp;#39;: &amp;#39;minieye_gt_database/...ian_92.bin&amp;#39;, &amp;#39;i,...,]\n        sampled = copy.deepcopy(sampled)\n        num_gt = gt_bboxes.shape[0]\n        num_sampled = len(sampled)\n        gt_bboxes_bv = box_np_ops.center_to_corner_box2d(gt_bboxes[:, 0:2], gt_bboxes[:, 3:5], gt_bboxes[:, 6])\n        sp_boxes = np.stack([i[&amp;#39;box3d_lidar&amp;#39;] for i in sampled], axis=0)\n        boxes = np.concatenate([gt_bboxes, sp_boxes], axis=0).copy()\n        sp_boxes_new = boxes[gt_bboxes.shape[0]:]\n        sp_boxes_bv = box_np_ops.center_to_corner_box2d(sp_boxes_new[:, 0:2], sp_boxes_new[:, 3:5], sp_boxes_new[:, 6])\n        total_bv = np.concatenate([gt_bboxes_bv, sp_boxes_bv], axis=0)\n        coll_mat = data_augment_utils.box_collision_test(total_bv, total_bv)\n        diag = np.arange(total_bv.shape[0])\n        coll_mat[diag, diag] = False\n        valid_samples = []\n        for i in range(num_gt, num_gt + num_sampled):\n            if coll_mat[i].any():\n                coll_mat[i] = False\n                coll_mat[:, i] = False\n            else:\n                valid_samples.append(sampled[i - num_gt])\n        return valid_samples                  # [{&amp;#39;name&amp;#39;: &amp;#39;Pedestrian&amp;#39;, &amp;#39;path&amp;#39;: &amp;#39;minieye_gt_database/.,.....]\n\'> </span>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/datasets/pipelines/dbsampler.py</p><span class=\'hidden-code\' data-code=\'class BatchSampler:\n    def _sample(self, num):\n        if self._idx + num >= self._example_num:\n            ret = self._indices[self._idx:].copy()\n            self._reset()\n        else:\n            ret = self._indices[self._idx:self._idx + num]        # array([45564, 65496, 31532, 40615])\n            self._idx += num                                      # 4\n        return ret\n    def _reset(self):\n        assert self._name is not None\n        if self._shuffle:\n            np.random.shuffle(self._indices)\n        self._idx = 0\n    def sample(self, num):\n        indices = self._sample(num)              # 4采样4个\n        return [self._sampled_list[i] for i in indices]\n\'> </span>'}]}]}]}]})</script><script src='https://study1994.github.io/study_html/npm/myjs/tooltip.js'></script>
</body>
</html>
