<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>kitti训练pointpillars流程</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/prism.css"><link rel="stylesheet" href="https://study1994.github.io/study_html/npm/markmap-toolbar@0.13.5/dist/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/d3@6.7.0"></script>
    <script src="https://study1994.github.io/study_html/npm/markmap-view@0.13.5"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">训练命令</p><font size="0"><pre class="language-bash"><code class="language-bash">{\n    "name": "Python:train.py",\n    "type": "python",\n    "request": "launch",\n    "program": "/sdb/zzhu/open_code/mmdetection3d/tools/train.py",\n    "console": "integratedTerminal",\n    "args": [\n        "--config", "configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py"\n    ],\n    "env": {\n        "CUDA_VISIBLE_DEVICES": "4"\n    },\n},\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">数据处理过程</p>\n<p><a href="configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py">hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class</a><br>\n<a href="configs/_base_/datasets/kitti-3d-3class.py#L102">RepeatDataset:configs/<em>base</em>/datasets/kitti-3d-3class.py</a><br>\n<a href="configs/_base_/datasets/kitti-3d-3class.py#L105">KittiDataset:configs/<em>base</em>/datasets/kitti-3d-3class.py</a><br>\n<a href="configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py#L24">LoadPointsFromFile:configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py</a><br>\n<a href="configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py#L25">LoadAnnotations3D:configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py</a><br>\n<a href="configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py#L26">ObjectSample:configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py</a><br>\n<a href="configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py#L12">DataBaseSampler:configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-3class.py</a><br></p>'}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">模型运行过程</p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/detectors/voxelnet.py</p><font size="0"><pre class="language-python"><code class="language-python">class VoxelNet(SingleStage3DDetector):\n    def forward_train(self,points,img_metas,gt_bboxes_3d,gt_labels_3d,gt_bboxes_ignore=None):\n        x = self.<span style=\'color: green;font-weight: bold;\'>extract_feat</span>(points, img_metas)                 <span style=\'color: red\'># len(points)=6；points[0].shape=torch.Size([18574, 4])</span>\n        outs = self.<span style=\'color: green;font-weight: bold;\'>bbox_head</span>(x)\n        loss_inputs = outs + (gt_bboxes_3d, gt_labels_3d, img_metas)\n        losses = self.bbox_head.<span style=\'color: green;font-weight: bold;\'>loss</span>(*loss_inputs, gt_bboxes_ignore=gt_bboxes_ignore)\n        return losses\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/detectors/voxelnet.py</p><font size="0"><pre class="language-python"><code class="language-python">class VoxelNet(SingleStage3DDetector):\n    def extract_feat(self, points, img_metas=None):\n        """Extract features from points."""\n        voxels, num_points, coors = self.<span style=\'color: green;font-weight: bold;\'>voxelize</span>(points)\n        voxel_features = self.<span style=\'color: green;font-weight: bold;\'>voxel_encoder</span>(voxels, num_points, coors)    <span style=\'color: red\'># torch.Size([34978, 64])</span>\n        batch_size = coors[-1, 0].item() + 1\n        x = self.<span style=\'color: green;font-weight: bold;\'>middle_encoder</span>(voxel_features, coors, batch_size)        <span style=\'color: red\'># torch.Size([6, 64, 496, 432]</span>\n        x = self.<span style=\'color: green;font-weight: bold;\'>backbone</span>(x)\n        if self.with_neck:\n            x = self.<span style=\'color: green;font-weight: bold;\'>neck</span>(x)\n        return x\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/detectors/voxelnet.py</p><font size="0"><pre class="language-python"><code class="language-python">class VoxelNet(SingleStage3DDetector):\n    def voxelize(self, points):\n        """Apply hard voxelization to points."""\n        voxels, coors, num_points = [], [], []\n        for res in points:\n            res_voxels, res_coors, res_num_points = self.<span style=\'color: green;font-weight: bold;\'>voxel_layer</span>(res)\n            voxels.append(res_voxels)\n            coors.append(res_coors)\n            num_points.append(res_num_points)\n        voxels = torch.cat(voxels, dim=0)                    <span style=\'color: red\'># voxels.shape=torch.Size([34978, 32, 4])=34978个体素，里面32个点云</span>\n        num_points = torch.cat(num_points, dim=0)            <span style=\'color: red\'># num_points.shape=torch.Size([34978]);num_points[0]=tensor(7, device=\'cuda:0\', dtype=torch.int32)=第一个体素只有7个点云</span>\n        coors_batch = []\n        for i, coor in enumerate(coors):\n            coor_pad = F.pad(coor, (1, 0), mode=\'constant\', value=i)\n            coors_batch.append(coor_pad)\n        coors_batch = torch.cat(coors_batch, dim=0)          <span style=\'color: red\'># coors.shape=torch.Size([34978，4]);coors[:,0]为某个体素属于那个batch;coors[:,2]y=(0,495);coors[:,3]x=(0,431)</span>\n        return voxels, num_points, coors_batch\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/ops/voxel/voxelize.py</p><font size="0"><pre class="language-python"><code class="language-python">class Voxelization(nn.Module):\n    def forward(self, input):\n        if self.training:\n            max_voxels = self.max_voxels[0]\n        else:\n            max_voxels = self.max_voxels[1]\n        return <span style=\'color: green;font-weight: bold;\'>voxelization</span>(input, self.voxel_size, self.point_cloud_range,self.max_num_points, max_voxels,self.deterministic)\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 6, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/ops/voxel/voxelize.py</p><font size="0"><pre class="language-python"><code class="language-python">class _Voxelization(Function):\n    @staticmethod\n    def forward(ctx,points,voxel_size,coors_range,max_points=35,max_voxels=20000,deterministic=True):\n        if max_points == -1 or max_voxels == -1:\n            coors = points.new_zeros(size=(points.size(0), 3), dtype=torch.int)\n            dynamic_voxelize(points, coors, voxel_size, coors_range, 3)\n            return coors\n        else:\n            voxels = points.new_zeros(size=(max_voxels, max_points, points.size(1)))  <span style=\'color: red\'># voxels.shape=torch.Size([16000, 32, 4])其中16000有配置文件设置  </span>\n            coors = points.new_zeros(size=(max_voxels, 3), dtype=torch.int)           <span style=\'color: red\'># coors.shape=torch.Size([16000, 3]) </span>\n            num_points_per_voxel = points.new_zeros(size=(max_voxels, ), dtype=torch.int)   <span style=\'color: red\'># num_points_per_voxel.shape=torch.Size([16000])</span>\n            voxel_num = <span style=\'color: green;font-weight: bold;\'>hard_voxelize</span>(points, voxels, coors,num_points_per_voxel, voxel_size,coors_range, max_points, max_voxels, 3,deterministic)\n            <span style=\'color: red\'># select the valid voxels</span>\n            voxels_out = voxels[:voxel_num]           <span style=\'color: red\'># voxels.shape=torch.Size([34978, 32, 4])=34978个体素，里面32个点云</span>\n            coors_out = coors[:voxel_num]             <span style=\'color: red\'># num_points.shape=torch.Size([34978]);num_points[0]=tensor(7, device=\'cuda:0\', dtype=torch.int32)=第一个体素只有7个点云</span>\n            num_points_per_voxel_out = num_points_per_voxel[:voxel_num]        <span style=\'color: red\'># coors.shape=torch.Size([34978，4]);coors[:,0]为某个体素属于那个batch;coors[:,2]y=(0,495);coors[:,3]x=(0,431)</span>\n            return voxels_out, coors_out, num_points_per_voxel_out\n</code></pre></font>'}]}]}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/voxel_encoders/pillar_encoder.py</p><font size="0"><pre class="language-python"><code class="language-python">class PillarFeatureNet(nn.Module):\n    def forward(self, features, num_points, coors):\n        features_ls = [features]\n        <span style=\'color: red\'># Find distance of x, y, and z from cluster center</span>\n        if self._with_cluster_center:\n            points_mean = features[:, :, :3].sum(dim=1, keepdim=True) / num_points.type_as(features).view(-1, 1, 1)\n            f_cluster = features[:, :, :3] - points_mean\n            features_ls.append(f_cluster)\n        <span style=\'color: red\'># Find distance of x, y, and z from pillar center</span>\n        dtype = features.dtype\n        if self._with_voxel_center:\n            if not self.legacy:\n                f_center = torch.zeros_like(features[:, :, :2])\n                f_center[:, :, 0] = features[:, :, 0] - (coors[:, 3].to(dtype).unsqueeze(1) * self.vx + self.x_offset)\n                f_center[:, :, 1] = features[:, :, 1] - (coors[:, 2].to(dtype).unsqueeze(1) * self.vy + self.y_offset)\n            else:\n                f_center = features[:, :, :2]\n                f_center[:, :, 0] = f_center[:, :, 0] - (coors[:, 3].type_as(features).unsqueeze(1) * self.vx + self.x_offset)\n                f_center[:, :, 1] = f_center[:, :, 1] - (coors[:, 2].type_as(features).unsqueeze(1) * self.vy + self.y_offset)\n            features_ls.append(f_center)\n        if self._with_distance:\n            points_dist = torch.norm(features[:, :, :3], 2, 2, keepdim=True)\n            features_ls.append(points_dist)\n        <span style=\'color: red\'># Combine together feature decorations</span>\n        features = torch.cat(features_ls, dim=-1)                           <span style=\'color: red\'># torch.Size([35245, 32, 9])</span>\n        <span style=\'color: red\'># The feature decorations were calculated without regard to whether pillar was empty. </span>\n        <span style=\'color: red\'># Need to ensure that empty pillars remain set to zeros.</span>\n        voxel_count = features.shape[1]     \n        mask = get_paddings_indicator(num_points, voxel_count, axis=0)       <span style=\'color: red\'># torch.Size([35245, 32])</span>\n        mask = torch.unsqueeze(mask, -1).type_as(features)\n        features *= mask                                                     <span style=\'color: red\'># torch.Size([35245, 32, 9])</span>\n        for pfn in self.pfn_layers:\n            features = <span style=\'color: green;font-weight: bold;\'>pfn</span>(features, num_points)                           \n        return features.squeeze(1)                                           <span style=\'color: red\'># torch.Size([34978, 64])</span>\n</code></pre></font>'}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/middle_encoders/pillar_scatter.py</p><font size="0"><pre class="language-python"><code class="language-python">class PointPillarsScatter(nn.Module):\n    def forward(self, voxel_features, coors, batch_size=None):\n        """Foraward function to scatter features."""\n        <span style=\'color: red\'># TODO: rewrite the function in a batch manner no need to deal with different batch cases</span>\n        if batch_size is not None:\n            return self.<span style=\'color: green;font-weight: bold;\'>forward_batch</span>(voxel_features, coors, batch_size)\n        else:\n            return self.forward_single(voxel_features, coors)\n</code></pre></font>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/middle_encoders/pillar_scatter.py</p><font size="0"><pre class="language-python"><code class="language-python">class PointPillarsScatter(nn.Module):\n    def forward_batch(self, voxel_features, coors, batch_size):     <span style=\'color: red\'># (N, M, C)、(N, 4).</span>\n        <span style=\'color: red\'># batch_canvas will be the final output.</span>\n        batch_canvas = []        <span style=\'color: red\'># batch_canvas will be the final output.</span>\n        for batch_itt in range(batch_size):\n            <span style=\'color: red\'># Create the canvas for this sample</span>\n            canvas = torch.zeros(self.in_channels,self.nx * self.ny,dtype=voxel_features.dtype,device=voxel_features.device)\n            <span style=\'color: red\'># Only include non-empty pillars</span>\n            batch_mask = coors[:, 0] == batch_itt\n            this_coors = coors[batch_mask, :]\n            indices = this_coors[:, 2] * self.nx + this_coors[:, 3]\n            indices = indices.type(torch.long)\n            voxels = voxel_features[batch_mask, :]\n            voxels = voxels.t()\n            <span style=\'color: red\'># Now scatter the blob back to the canvas.</span>\n            canvas[:, indices] = voxels\n            <span style=\'color: red\'># Append to a list for later stacking.</span>\n            batch_canvas.append(canvas)\n        <span style=\'color: red\'># Stack to 3-dim tensor (batch-size, in_channels, nrows*ncols)</span>\n        batch_canvas = torch.stack(batch_canvas, 0)\n        <span style=\'color: red\'># Undo the column stacking to final 4-dim tensor</span>\n        batch_canvas = batch_canvas.view(batch_size, self.in_channels, self.ny,self.nx)     <span style=\'color: red\'># x.shape=torch.Size([6, 64, 496, 432]</span>\n        return batch_canvas\n</code></pre></font>'}]}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/backbones/second.py</p><font size="0"><pre class="language-python"><code class="language-python">class SECOND(BaseModule):\n    def forward(self, x):          <span style=\'color: red\'># (N, C, H, W).</span>\n        outs = []\n        for i in range(len(self.blocks)):\n            x = self.blocks[i](x)\n            outs.append(x)         <span style=\'color: red\'># torch.Size([6, 64, 496, 432]->[[6, 64, 248, 216]x2,[6, 128, 124, 108]x4,[6, 256, 62, 54]x8]</span>\n        return tuple(outs)\n</code></pre></font>'}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/necks/second_fpn.py</p><font size="0"><pre class="language-python"><code class="language-python">class SECONDFPN(BaseModule):\n    def forward(self, x):\n        assert len(x) == len(self.in_channels)\n        ups = [deblock(x[i]) for i, deblock in enumerate(self.deblocks)]\n        if len(ups) > 1:\n            out = torch.cat(ups, dim=1)     <span style=\'color: red\'># torch.Size([6, 384, 248, 216])384=128x3</span>\n        else:\n            out = ups[0]\n        return [out]\n</code></pre></font>'}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/anchor3d_head.py</p><font size="0"><pre class="language-python"><code class="language-python">class Anchor3DHead(BaseModule, AnchorTrainMixin):\n    def forward_single(self, x):                <span style=\'color: red\'># anchor有6个</span>\n        cls_score = self.conv_cls(x)            <span style=\'color: red\'># torch.Size([6, 18, 248, 216])=>18=6x3</span>\n        bbox_pred = self.conv_reg(x)            <span style=\'color: red\'># torch.Size([6, 42, 248, 216])=>42=6x8</span>\n        dir_cls_preds = None                    <span style=\'color: red\'># torch.Size([6, 12, 248, 216])=>12=6x2</span>\n        if self.use_direction_classifier: \n            dir_cls_preds = self.conv_dir_cls(x)\n        return cls_score, bbox_pred, dir_cls_preds\n</code></pre></font>'}]}]}]}, {'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">软件测试流程</p><font size="0"><pre class="language-"><code class="language-">{\n    "name": "Python: test.py",\n    "type": "python",\n    "request": "launch",\n    "program": "tools/test.py",\n    "console": "integratedTerminal",\n    "args": [\n        "configs/pointpillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-car.py",\n        "pretrain/PointPillars/hv_pointpillars_secfpn_6x8_160e_kitti-3d-car_20200620_230614-77663cd6.pth",\n        <span style=\'color: red\'>// "--out","/sdb/zzhu/open_code/mmdetection3d/tools/test_res/kitti/",</span>\n        "--format_only"\n    ],\n    "env": {\n        "CUDA_VISIBLE_DEVICES": "0"\n    },\n},\n</code></pre></font>'}]})</script></body>
</html>
