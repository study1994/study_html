<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>smock运行过程</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://study1994.github.io/study_html/npm/prism.css"><link rel="stylesheet" href="https://study1994.github.io/study_html/npm/markmap-toolbar@0.13.5/dist/style.css">
</head>
<body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/d3@6.7.0"></script>
    <script src="https://study1994.github.io/study_html/npm/markmap-view@0.13.5"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"></script>
    <script>
        (r => {
            setTimeout(r);
        })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{'type': 'root', 'depth': 0, 'content': '', 'children': [{'type': 'heading', 'depth': 1, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">SMOKEMono3DHead</p>', 'children': [{'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/smoke_mono3d_head.py:def forward_single</p>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/anchor_free_mono3d_head.py:def forward_single</p>x.shape->torch.Size([8, 64, 96, 320]),4倍下采样;self.cls_convs，self.reg_convs为空<br>\ncls_feat=torch.Size([8, 64, 96, 320])->【clone_cls_feat->torch.Size([8, 256, 96, 320])->cls_score三类=torch.Size([8, 3, 96, 320])】<br>\nreg_feat=torch.Size([8, 64, 96, 320])->【clone_reg_feat->torch.Size([8, 256, 96, 320])->bbox_pred-=torch.Size([8, 8, 96, 320])】<br>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/smoke_mono3d_head.py:def forward_single</p>cls_score->torch.Size([8, 3, 96, 320])【sigmoid+clamp】8为batch size，3为类别<br>\n对预测的bbox_pred<br>\nself.dim_channel=[3,4,5]->将offset_dims进行sigmoid<br>\nself.ori_channel=[6,7]->将vector_ori进行F.normalize-对1维进行正则化<br>'}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/smoke_mono3d_head.py:def loss</p>cls_scores-[8, 3, 96, 320],bbox_preds-[8, 8, 96, 320]；<br>\ngt_bboxes-[torch.Size([1, 4]) ,...],[torch.Size([n]) ,...]。对应2D label<br>\ngt_bboxes_3d[CameraInstance3DBoxes(tensor([[-2.5853,  1.4700,  8.9600,  0.7300,  1.7600,  0.5600,  0.3500]])),...],gt_labels_3d,<br>\ncenters2d-[torch.Size([8, 2]),...],<br>\ncenter2d_heatmap_target, avg_factor, target_labels = self.get_targets<br>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/smoke_mono3d_head.py:def get_targets</p>reg_mask=tensor([ True,  True,  True, False,  True,  True,  True,  True],device=\'cuda:0\')第四个有affine_aug为False<br>\nwidth_ratio = height_ratio = 1/4<br>\ncenter_heatmap_target.shape=torch.Size([8, 3, 96, 320])--由中心的及对应的label决定<br>\navg_factor=42,总共42个label,数据增强后结果<br>\nnum_ctrs=[1, 8, 4, 2, 10, 7, 8, 2]-sum=42,max_objs=10<br>\nreg_inds-torch.Size([42]); inds-torch.Size([8, 10])--有值的为1<br>\n8为batch size； 10为最大box数； 最后一个3为x,y,z<br>\nbatch_centers2d-torch.Size([8, 10, 2])-->torch.Size([80, 2])到原图片中心点->；<br>\nbatch_labels_3d-torch.Size([8, 10])-->torch.Size([80, 3]);<br>\nbatch_gt_locations-torch.Size([8, 10, 3])-对应x,y,z<br>\ninds-torch.Size([8, 10])-torch.Size([80])<br>\ngt_dimensions-torch.Size([42, 3])-对应w,h,l<br>\ngt_orientations-torch.Size([42, 1])-对应角度<br>\ngt_corners-torch.Size([42, 8, 3])-对应8个顶点<br>'}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/smoke_mono3d_head.py:def loss</p>avg_factor为总共42个label,数据增强后结果<br>\npred_bboxes = self.get_predictions；输入预测的box-[8, 8, 96, 320]等<br>', 'children': [{'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/smoke_mono3d_head.py:def get_predictions</p>cam2imgs.shape=torch.Size([8, 4, 4]); trans_mats-torch.Size([8, 3, 3])<br>\ncenters2d_inds-torch.Size([8, 10])<br>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">site-packages/mmdet/models/utils/gaussian_target.py:def transpose_and_gather_feat</p>channel=8代表0是深度offsets,1:3是中心偏移，<br>\nfeat-torch.Size([8, 8, 96, 320])-torch.Size([8, 96, 320, 8])-torch.Size([8, 30720, 8])<br>\n+torch.Size([8, 10])=>torch.Size([8, 10, 8])-bs=8,10个box<br>'}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/smoke_mono3d_head.py:def get_predictions</p>pred_regression_pois->torch.Size([80, 8])；80个box的8个预测<br>\nlocations, dimensions, orientations = self.bbox_coder.decode输入<br>\n预测的中心2D,centers2d-torch.Size([80, 2])；labels3d-torch.Size([8, 10])；gt_locations-torch.Size([80, 3])<br>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/core/bbox/coders/smoke_bbox_coder.py：class SMOKECoder：def decode</p>depth_offsets-torch.Size([80])->根据base_depth=(28.01, 16.32)->depths:torch.Size([80])<br>\n输入self._decode_location：<br>\n中心点：points-torch.Size([80, 2])<br>\n中心偏移-centers2d_offsets<br>\n中心深度-depths, cam2imgs, trans_mats<br>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/core/bbox/coders/smoke_bbox_coder.py：class SMOKECoder：def _decode_location</p>locations->torch.Size([80, 4])<br>'}]}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/core/bbox/coders/smoke_bbox_coder.py：class SMOKECoder：def decode</p>输入self._decode_dimension<br>\nlabels-torch.Size([8, 10])<br>\ndimensions_offsets-torch.Size([80, 3])<br>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/core/bbox/coders/smoke_bbox_coder.py：class SMOKECoder：def _decode_dimension</p>根据基本维度+dims_offset得到decode_dimension<br>'}]}, {'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/core/bbox/coders/smoke_bbox_coder.py：class SMOKECoder：def decode</p>输入self._decode_orientation<br>\norientations-torch.Size([80, 2])预测的旋转角sin(alphas),cos(alphas)-->看到的角度<br>\nlocations-torch.Size([80, 3])中心位置<br>', 'children': [{'type': 'heading', 'depth': 5, 'payload': {'lines': [0, 1]}, 'content': '<p>mmdet3d/core/bbox/coders/smoke_bbox_coder.py：class SMOKECoder：<a href="https://github.com/open-mmlab/mmdetection3d/blob/master/mmdet3d/core/bbox/coders/smoke_bbox_coder.py#L185">def _decode_orientation</a><br>\n预测的中心的locations的相机坐标系--》z向前，x向右，y向下--》rays<br>\nyaws(用于计算损失的) = alphas(预测的) + rays(中心点预测的)<br>\nalphas范围[-pi/2,pi/2]-&gt;<br>\n最后yaw的范围为-pi到pi<br></p>'}]}]}, {'type': 'heading', 'depth': 3, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/smoke_mono3d_head.py:def get_predictions</p>返回的locations-torch.Size([80, 3]), dimensions-torch.Size([80, 3]), orientations-torch.Size([80, 1])；<br>\n输入self.bbox_coder.encode：要预测某一个量的时候，其它当作真的<br>', 'children': [{'type': 'heading', 'depth': 4, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/core/bbox/coders/smoke_bbox_coder.py：class SMOKECoder：def encode</p>'}]}]}, {'type': 'heading', 'depth': 2, 'payload': {'lines': [0, 1]}, 'content': '<p style="color: blue;font-weight: bold;">mmdet3d/models/dense_heads/smoke_mono3d_head.py:def loss</p>最后计算的是根据8个顶点的差值<br>'}]}]})</script></body>
</html>
