<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>pnp_det损失计算过程</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      #mindmap {
        display: block;
        width: 100vw;
        height: 100vh;
      }
      .hidden-code {
        display: none !important;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://study1994.github.io/study_html/npm/mycss/style.css"
    />
  </head>
  <body>
    <svg id="mindmap"></svg>
    <script src="https://study1994.github.io/study_html/npm/myjs/d3@6.7.0.js"></script>
    <script src="https://study1994.github.io/study_html/npm/myjs/markmap-view@0.13.5.js"></script>
    <script
      type="text/javascript"
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_HTMLorMML-full"
    ></script>
    <script>
      ((r) => {
        setTimeout(r);
      })(() => {
        const { markmap, mm } = window;
        const toolbar = new markmap.Toolbar();
        toolbar.attach(mm);
        const el = toolbar.render();
        el.setAttribute("style", "position:absolute;bottom:20px;right:20px");
        document.body.append(el);
      });
    </script>
    <script>
      ((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create(
          "svg#mindmap",
          (getOptions || markmap.deriveOptions)(jsonOptions),
          root
        );
      })(() => window.markmap, null, {
        type: "root",
        depth: 0,
        content: "",
        children: [
          {
            type: "heading",
            depth: 1,
            payload: { lines: [0, 1] },
            content:
              '<p style="color: blue;font-weight: bold;">损失计算过程</p>',
            children: [
              {
                type: "heading",
                depth: 2,
                payload: { lines: [0, 1] },
                content:
                  "<p style=\"color: blue;font-weight: bold;\">epropnp_det/models/dense_heads/deform_pnp_head.py</p><span class='hidden-code' data-code='class DeformPnPHead(BaseDenseHead):\n        def forward_train(self,\n                      mlvl_feats,                # [i.shape for i in mlvl_feats](1600, 900) = [torch.Size([6, 256, 84, 200])x8, torch.Size([6, 256, 42, 100])x16, torch.Size([6, 256, 21, 50])x32, torch.Size([6, 256, 11, 25])x64, torch.Size([6, 256, 6, 13])x128]\n                      img_metas,                 # 6张图片[,,...],img_metas[0][&amp;#39;ori_shape&amp;#39;]=(900, 1600, 3);img_metas[0][&amp;#39;img_shape&amp;#39;]=(672, 1600, 3);img_metas[0][&amp;#39;pad_shape&amp;#39;]=(672, 1600, 3);img_metas[0][&amp;#39;flip&amp;#39;]=True;img_metas[0][&amp;#39;flip_direction&amp;#39;]=&amp;#39;horizontal&amp;#39;\n                      gt_bboxes,                 # 6个2D box[,,...],gt_bboxes[0].shape=torch.Size([3, 4])\n                      gt_labels=None,            # 6个2D box[,,...],gt_labels[0].shape=torch.Size([3])\n                      gt_bboxes_ignore=None,     \n                      gt_bboxes_3d=None,         # 6个3D box[,,...],gt_bboxes_3d[0].shape=torch.Size([3, 7])-->对着的是原始图片\n                      gt_x3d=None,               # 6个 box第一个box有n个值，gt_x3d[0][0].shape=torch.Size([2, 3])；gt_x3d[0][1].shape=torch.Size([1, 3])；...；gt_x3d[0][n].shape=torch.Size([433, 3])；\n                      gt_x2d=None,               # 6个 box第一个box有n个值，gt_x2d[0][0].shape=torch.Size([2, 2])；gt_x2d[0][1].shape=torch.Size([1, 2])；...；gt_x2d[0][n].shape=torch.Size([433, 2])；\n                      gt_attr=None,\n                      gt_velo=None,\n                      img_dense_x2d=None,        # img_dense_x2d.shape=torch.Size([6, 2, 672, 1600])       # img_dense_x2d这个是一样的吗？每个\n                      img_dense_x2d_mask=None,   # img_dense_x2d_mask.shape=torch.Size([6, 1, 672, 1600])\n                      cam_intrinsic=None):       # cam_intrinsic[0].shape=torch.Size([3, 3])\n        # ===== prepare img metas and g.t. =====\n'> </span>",
                children: [
                  {
                    type: "heading",
                    depth: 3,
                    payload: { lines: [0, 1] },
                    content:
                      "<p style=\"color: blue;font-weight: bold;\">epropnp_det/core/bbox_3d/center_target.py</p><span class='hidden-code' data-code='class VolumeCenter(object):               # 体积中心\n    def get_centers_2d(self, bboxes_2d, bboxes_3d, obj_img_inds, img_dense_x2d_small, img_dense_x2d_mask_small,cam_intrinsic, max_shape)\n        num_obj = bboxes_3d.size(0)                    # 22\n        num_img = cam_intrinsic.size(0)                # 6\n        pad_shape = torch.ceil(max_shape / self.output_stride) * self.output_stride           # tensor([ 900., 1600.], device=&amp;#39;cuda:0&amp;#39;)->tensor([ 904., 1600.], device=&amp;#39;cuda:0&amp;#39;)8的倍数\n        verts = self.base_mesh.verts_list()[0].to(device) * 0.5  # (vn, 3)     torch.Size([8, 3])值为-0.5或0.5，中心点为原点的长宽高为1的3D box\n        faces = self.base_mesh.faces_list()[0].to(device)        # (fn, 3)     torch.Size([12, 3])\n        vn = verts.size(0)\n        fn = faces.size(0)\n        verts = verts[None].expand(num_obj, -1, -1)  # (num_obj, vn, 3)  torch.Size([22, 8, 3])\n        verts_oc = verts * bboxes_3d[:, None, :3]    # torch.Size([22, 8, 3]),长宽高乘以那8个顶点\n        # =====transform to opencv camera space=====\n        rot_mats = yaw_to_rot_mat(bboxes_3d[:, 6])  # (num_obj, 3, 3)          得到旋转矩阵\n        # (num_obj, vn, 3) = ((num_obj, 3, 3) @ (num_obj, 3, vn)) -> (num_obj, vn, 3) + (num_obj, 1, 3)\n        verts_cam = (rot_mats @ verts_oc.transpose(-1, -2)).transpose(-1, -2) + bboxes_3d[:, None, 3:6]    # torch.Size([22, 8, 3])得到22个3Dbox的8个顶点\n        # =====join meshes as scenes=====\n        verts_list = []  # list of scenes\n        faces_list = []\n        num_obj_per_img_list = []\n        img_has_object_list = []\n        for i in range(num_img):                        # 6张图片\n            verts_scene = verts_cam[obj_img_inds == i]  # (num_obj_per_img, vn, 3)       # torch.Size([4, 8, 3])\n            num_obj_per_img = verts_scene.size(0)\n            img_has_object = num_obj_per_img > 0\n            if img_has_object:                                                           # 该张图片有3D box\n                faces_scene = faces.unsqueeze(0).expand(num_obj_per_img, -1, -1)         # (num_obj_per_img, fn, 3)  torch.Size([4, 12, 3])\n                faces_scene = faces_scene + torch.arange(0, num_obj_per_img * vn, step=vn, device=device)[:, None, None]      # reindex  torch.Size([4, 12, 3]) / vn=8    tensor([[[ 0]],[[ 8]],[[16]],[[24]]], device=&amp;#39;cuda:0&amp;#39;)\n                verts_list.append(verts_scene.reshape(num_obj_per_img * vn, 3))          # 顶点          第一个值的shape=torch.Size([32, 3])\n                faces_list.append(faces_scene.reshape(num_obj_per_img * fn, 3))          # 对应顶点索引   第一个值的shape=torch.Size([48, 3])\n            num_obj_per_img_list.append(num_obj_per_img)                                 # [4, 5, 2, 2, 3, 6]\n            img_has_object_list.append(img_has_object)                                   # [True, True, True, True, True, True]\n        scene_meshes = Meshes(verts=verts_list, faces=faces_list)      \n        # =====select images with objects=====\n        img_has_object_list = torch.tensor(img_has_object_list, dtype=torch.bool, device=device)    # tensor([True, True, True, True, True, True], device=&amp;#39;cuda:0&amp;#39;)\n        img_dense_x2d_small = img_dense_x2d_small[img_has_object_list]                              # torch.Size([6, 2, 84, 200])\n        img_dense_x2d_mask_small = img_dense_x2d_mask_small[img_has_object_list]                    # torch.Size([6, 1, 84, 200])\n        cam_intrinsic = cam_intrinsic[img_has_object_list]\n        obj_img_inds_new = (img_has_object_list.cumsum(dim=0) - 1)[obj_img_inds]                    # img_has_object_list.cumsum(dim=0) - 1--》 torch.Size([22])\n        # =====camera conversion=====\n        f = cam_intrinsic[:, [0, 1], [0, 1]]   # (num_img, 2) [fx, fy]    torch.Size([6, 2])\n        p = cam_intrinsic[:, :2, 2]            # (num_img, 2) [px, py]\n        half_shape = pad_shape / 2             # (2, ) [h, w]     tensor([ 904., 1600.], device=&amp;#39;cuda:0&amp;#39;)->tensor([452., 800.], device=&amp;#39;cuda:0&amp;#39;)\n        denom = torch.min(half_shape)          # 452\n        cameras = PerspectiveCameras(focal_length=-f / denom,principal_point=(half_shape[[1, 0]] - (p + 0.5)) / denom,device=device)\n        # =====rasterize=====\n        h_rend, w_rend = int(pad_shape[0]) // self.render_stride, int(pad_shape[1]) // self.render_stride    # self.render_stride=4 --->226,400\n        raster_settings = RasterizationSettings(image_size=(h_rend, w_rend),blur_radius=0.0, faces_per_pixel=self.faces_per_pixel,z_clip_value=1e-2)\n        frags = self.rasterizer(scene_meshes, cameras=cameras, raster_settings=raster_settings)\n        pix_to_face = frags.pix_to_face  # (num_img, h_rend, w_rend, faces_per_pixel)      # torch.Size([6, 226, 400, 16])\n        zbuf = frags.zbuf                # (num_img, h_rend, w_rend, faces_per_pixel)      # torch.Size([6, 226, 400, 16])\n        # =====post proc=====\n        if num_obj > self.max_gpu_obj > 0:      # num_obj > False > 0\n            bboxes_2d = bboxes_2d.cpu()\n            zbuf = zbuf.cpu()\n            pix_to_face = pix_to_face.cpu()\n            img_dense_x2d_small = img_dense_x2d_small.cpu()\n            img_dense_x2d_mask_small = img_dense_x2d_mask_small.cpu()\n            pad_shape = pad_shape.cpu()\n            obj_img_inds_new = obj_img_inds_new.cpu()\n        centers_2d, bboxes_2d, valid_mask = self.post_proc(zbuf, pix_to_face, img_dense_x2d_small, img_dense_x2d_mask_small,pad_shape, num_obj, obj_img_inds_new, bboxes_2d, fn)        \n'> </span>\nverts<br>\n<span class='hidden-code' data-code='tensor([[-0.5000, -0.5000,  0.5000],\n        [ 0.5000, -0.5000,  0.5000],\n        [-0.5000,  0.5000,  0.5000],\n        [ 0.5000,  0.5000,  0.5000],\n        [-0.5000, -0.5000, -0.5000],\n        [ 0.5000, -0.5000, -0.5000],\n        [-0.5000,  0.5000, -0.5000],\n        [ 0.5000,  0.5000, -0.5000]], device=&amp;#39;cuda:0&amp;#39;)\n'> </span>\nfaces<br>\n<span class='hidden-code' data-code='tensor([[0, 1, 2],\n        [1, 3, 2],\n        [2, 3, 7],\n        [2, 7, 6],\n        [1, 7, 3],\n        [1, 5, 7],\n        [6, 7, 4],\n        [7, 5, 4],\n        [0, 4, 1],\n        [1, 4, 5],\n        [2, 6, 4],\n        [0, 2, 4]], device=&amp;#39;cuda:0&amp;#39;)\n'> </span>",
                    children: [
                      {
                        type: "heading",
                        depth: 4,
                        payload: { lines: [0, 1] },
                        content:
                          "<p style=\"color: blue;font-weight: bold;\">epropnp_det/core/bbox_3d/center_target.py</p><span class='hidden-code' data-code='class VolumeCenter(object):               # 体积中心\n    def post_proc(self, zbuf, pix_to_face, img_dense_x2d_small, img_dense_x2d_mask_small,pad_shape, num_obj, obj_img_inds, bboxes_2d, fn)\n'> </span>",
                      },
                    ],
                  },
                  {
                    type: "heading",
                    depth: 3,
                    payload: { lines: [0, 1] },
                    content:
                      "<p style=\"color: blue;font-weight: bold;\">epropnp_det/core/bbox_3d/center_target.py</p><span class='hidden-code' data-code='class VolumeCenter(object):               # 体积中心\n    def get_centers_2d(self, bboxes_2d, bboxes_3d, obj_img_inds, img_dense_x2d_small, img_dense_x2d_mask_small,cam_intrinsic, max_shape)\n'> </span>",
                  },
                ],
              },
              {
                type: "heading",
                depth: 2,
                payload: { lines: [0, 1] },
                content:
                  "<p style=\"color: blue;font-weight: bold;\">epropnp_det/models/dense_heads/deform_pnp_head.py</p><span class='hidden-code' data-code='class DeformPnPHead(BaseDenseHead):\n        def forward_train()\n'> </span>",
              },
            ],
          },
        ],
      });
    </script>
    <script src="https://study1994.github.io/study_html/npm/myjs/tooltip.js"></script>
  </body>
</html>
